<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=latin1">
  <style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #808080 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0040D0 } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * CPView.j</span>
<span class="cm"> * AppKit</span>
<span class="cm"> *</span>
<span class="cm"> * Created by Francisco Tolmasky.</span>
<span class="cm"> * Copyright 2008, 280 North, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This library is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="cm"> * License as published by the Free Software Foundation; either</span>
<span class="cm"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This library is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span class="cm"> * Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="cm"> * License along with this library; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>
<span class="cm"> */</span>

<span class="k">@import</span> <span class="s2">&lt;Foundation/CPArray.j&gt;</span>
<span class="k">@import</span> <span class="s2">&lt;Foundation/CPObjJRuntime.j&gt;</span>

<span class="k">@import</span> <span class="s2">&quot;CGAffineTransform.j&quot;</span>
<span class="k">@import</span> <span class="s2">&quot;CGGeometry.j&quot;</span>

<span class="k">@import</span> <span class="s2">&quot;CPColor.j&quot;</span>
<span class="k">@import</span> <span class="s2">&quot;CPGeometry.j&quot;</span>
<span class="k">@import</span> <span class="s2">&quot;CPGraphicsContext.j&quot;</span>
<span class="k">@import</span> <span class="s2">&quot;CPResponder.j&quot;</span>
<span class="k">@import</span> <span class="s2">&quot;CPTheme.j&quot;</span>
<span class="k">@import</span> <span class="s2">&quot;_CPDisplayServer.j&quot;</span>


<span class="cp">#include </span><span class="s2">&quot;Platform/Platform.h&quot;</span>
<span class="cp">#include </span><span class="s2">&quot;CoreGraphics/CGAffineTransform.h&quot;</span>
<span class="cp">#include </span><span class="s2">&quot;CoreGraphics/CGGeometry.h&quot;</span>
<span class="cp">#include </span><span class="s2">&quot;Platform/DOM/CPDOMDisplayServer.h&quot;</span><span class="cm"></span>

<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    The default resizingMask, the view will not resize or reposition itself.</span>
<span class="cm">*/</span>
<span class="nx">CPViewNotSizable</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    Allow for flexible space on the left hand side of the view.</span>
<span class="cm">*/</span>
<span class="nx">CPViewMinXMargin</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    The view should grow and shrink horizontally with its parent view.</span>
<span class="cm">*/</span>
<span class="nx">CPViewWidthSizable</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    Allow for flexible space to the right hand side of the view.</span>
<span class="cm">*/</span>
<span class="nx">CPViewMaxXMargin</span>    <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    Allow for flexible space above the view.</span>
<span class="cm">*/</span>
<span class="nx">CPViewMinYMargin</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    The view should grow and shrink vertically with its parent view.</span>
<span class="cm">*/</span>
<span class="nx">CPViewHeightSizable</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    Allow for flexible space below the view.</span>
<span class="cm">*/</span>
<span class="nx">CPViewMaxYMargin</span>    <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="nx">CPViewBoundsDidChangeNotification</span>   <span class="o">=</span> <span class="s2">@&quot;CPViewBoundsDidChangeNotification&quot;</span><span class="p">;</span>
<span class="nx">CPViewFrameDidChangeNotification</span>    <span class="o">=</span> <span class="s2">@&quot;CPViewFrameDidChangeNotification&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">CachedNotificationCenter</span>    <span class="o">=</span> <span class="nx">nil</span><span class="p">,</span>
    <span class="nx">CachedThemeAttributes</span>       <span class="o">=</span> <span class="nx">nil</span><span class="p">;</span>

<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">DOMElementPrototype</span>         <span class="o">=</span> <span class="nx">nil</span><span class="p">,</span>
    
    <span class="nx">BackgroundTrivialColor</span>              <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">BackgroundVerticalThreePartImage</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">BackgroundHorizontalThreePartImage</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">BackgroundNinePartImage</span>             <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="kd">var</span> <span class="nx">CPViewFlags</span>                     <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
    <span class="nx">CPViewHasCustomDrawRect</span>         <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">CPViewHasCustomLayoutSubviews</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/*! </span>
<span class="cm">    @ingroup appkit</span>
<span class="cm">    @class CPView</span>

<span class="cm">    &lt;p&gt;CPView is a class which provides facilities for drawing</span>
<span class="cm">    in a window and receiving events. It is the superclass of many of the visual</span>
<span class="cm">    elements of the GUI.&lt;/p&gt;</span>

<span class="cm">    &lt;p&gt;In order to display itself, a view must be placed in a window (represented by an</span>
<span class="cm">    CPWindow object). Within the window is a hierarchy of CPViews,</span>
<span class="cm">    headed by the window&#39;s content view. Every other view in a window is a descendant</span>
<span class="cm">    of this view.&lt;/p&gt;</span>

<span class="cm">    &lt;p&gt;Subclasses can override \c -drawRect: in order to implement their</span>
<span class="cm">    appearance. Other methods of CPView and CPResponder can</span>
<span class="cm">    also be overridden to handle user generated events.</span>
<span class="cm">*/</span>
<span class="k">@implementation</span> <span class="nc">CPView</span> : <span class="nc">CPResponder</span>
<span class="p">{</span>
    <span class="kt">CPWindow</span>            <span class="n">_window</span><span class="p">;</span>
    
    <span class="kt">CPView</span>              <span class="n">_superview</span><span class="p">;</span>
    <span class="kt">CPArray</span>             <span class="n">_subviews</span><span class="p">;</span>
    
    <span class="kt">CPGraphicsContext</span>   <span class="n">_graphicsContext</span><span class="p">;</span>
    
    <span class="kt">int</span>                 <span class="n">_tag</span><span class="p">;</span>
    
    <span class="kt">CGRect</span>              <span class="n">_frame</span><span class="p">;</span>
    <span class="kt">CGRect</span>              <span class="n">_bounds</span><span class="p">;</span>
    <span class="kt">CGAffineTransform</span>   <span class="n">_boundsTransform</span><span class="p">;</span>
    <span class="kt">CGAffineTransform</span>   <span class="n">_inverseBoundsTransform</span><span class="p">;</span>
    
    <span class="kt">CPSet</span>               <span class="n">_registeredDraggedTypes</span><span class="p">;</span>
    <span class="kt">CPArray</span>             <span class="n">_registeredDraggedTypesArray</span><span class="p">;</span>
    
    <span class="kt">BOOL</span>                <span class="n">_isHidden</span><span class="p">;</span>
    <span class="kt">BOOL</span>                <span class="n">_hitTests</span><span class="p">;</span>
    
    <span class="kt">BOOL</span>                <span class="n">_postsFrameChangedNotifications</span><span class="p">;</span>
    <span class="kt">BOOL</span>                <span class="n">_postsBoundsChangedNotifications</span><span class="p">;</span>
    <span class="kt">BOOL</span>                <span class="n">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">;</span>
    
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
    <span class="kt">DOMElement</span>          <span class="n">_DOMElement</span><span class="p">;</span>
    <span class="kt">DOMElement</span>          <span class="n">_DOMContentsElement</span><span class="p">;</span>
    
    <span class="kt">CPArray</span>             <span class="n">_DOMImageParts</span><span class="p">;</span>
    <span class="kt">CPArray</span>             <span class="n">_DOMImageSizes</span><span class="p">;</span>
    
    <span class="kt">unsigned</span>            <span class="n">_backgroundType</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="kt">CGRect</span>              <span class="n">_dirtyRect</span><span class="p">;</span>

    <span class="kt">float</span>               <span class="n">_opacity</span><span class="p">;</span>
    <span class="kt">CPColor</span>             <span class="n">_backgroundColor</span><span class="p">;</span>

    <span class="kt">BOOL</span>                <span class="n">_autoresizesSubviews</span><span class="p">;</span>
    <span class="kt">unsigned</span>            <span class="n">_autoresizingMask</span><span class="p">;</span>
    
    <span class="kt">CALayer</span>             <span class="n">_layer</span><span class="p">;</span>
    <span class="kt">BOOL</span>                <span class="n">_wantsLayer</span><span class="p">;</span>
    
    <span class="c1">// Full Screen State</span>
    <span class="kt">BOOL</span>                <span class="n">_isInFullScreenMode</span><span class="p">;</span>
    
    <span class="kt">_CPViewFullScreenModeState</span>  <span class="n">_fullScreenModeState</span><span class="p">;</span>
    
    <span class="c1">// Layout Support</span>
    <span class="kt">BOOL</span>                <span class="n">_needsLayout</span><span class="p">;</span>
    <span class="kt">JSObject</span>            <span class="n">_ephemeralSubviews</span><span class="p">;</span>
    
    <span class="c1">// Theming Support</span>
    <span class="kt">CPTheme</span>             <span class="n">_theme</span><span class="p">;</span>
    <span class="kt">JSObject</span>            <span class="n">_themeAttributes</span><span class="p">;</span>
    <span class="kt">unsigned</span>            <span class="n">_themeState</span><span class="p">;</span>

    <span class="kt">JSObject</span>            <span class="n">_ephemeralSubviewsForNames</span><span class="p">;</span>
    <span class="kt">CPSet</span>               <span class="n">_ephereralSubviews</span><span class="p">;</span>

    <span class="c1">// Key View Support</span>
    <span class="kt">CPView</span>              <span class="n">_nextKeyView</span><span class="p">;</span>
    <span class="kt">CPView</span>              <span class="n">_previousKeyView</span><span class="p">;</span>

    <span class="kt">unsigned</span>            <span class="n">_viewClassFlags</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">    Private method for Objective-J.</span>
<span class="cm">    @ignore</span>
<span class="cm">*/</span>
<span class="o">+</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">initialize</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">self</span> <span class="o">!==</span> <span class="k">[</span><span class="nx">CPView</span> <span class="nl">class</span><span class="k">]</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
    <span class="nx">DOMElementPrototype</span> <span class="o">=</span>  <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">DOMElementPrototype</span><span class="p">.</span><span class="nx">style</span><span class="p">;</span>
    
    <span class="nx">style</span><span class="p">.</span><span class="nx">overflow</span> <span class="o">=</span> <span class="s2">&quot;hidden&quot;</span><span class="p">;</span>
    <span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;absolute&quot;</span><span class="p">;</span>
    <span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s2">&quot;visible&quot;</span><span class="p">;</span>
    <span class="nx">style</span><span class="p">.</span><span class="nx">zIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="nx">CachedNotificationCenter</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPNotificationCenter</span> <span class="nl">defaultCenter</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">setupViewFlags</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">theClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">class</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">classUID</span> <span class="o">=</span> <span class="k">[</span><span class="nx">theClass</span> <span class="nl">UID</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">CPViewFlags</span><span class="p">[</span><span class="nx">classUID</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">theClass</span> <span class="nl">instanceMethodForSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">drawRect:</span><span class="p">)</span><span class="k">]</span> <span class="o">!==</span> <span class="k">[</span><span class="nx">CPView</span> <span class="nl">instanceMethodForSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">drawRect:</span><span class="p">)</span><span class="k">]</span><span class="p">)</span>
            <span class="nx">flags</span> <span class="o">|=</span> <span class="nx">CPViewHasCustomDrawRect</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">theClass</span> <span class="nl">instanceMethodForSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">layoutSubviews</span><span class="p">)</span><span class="k">]</span> <span class="o">!==</span> <span class="k">[</span><span class="nx">CPView</span> <span class="nl">instanceMethodForSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">layoutSubviews</span><span class="p">)</span><span class="k">]</span><span class="p">)</span>
            <span class="nx">flags</span> <span class="o">|=</span> <span class="nx">CPViewHasCustomLayoutSubviews</span><span class="p">;</span>

        <span class="nx">CPViewFlags</span><span class="p">[</span><span class="nx">classUID</span><span class="p">]</span> <span class="o">=</span> <span class="nx">flags</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">_viewClassFlags</span> <span class="o">=</span> <span class="nx">CPViewFlags</span><span class="p">[</span><span class="nx">classUID</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="nx">CPSet</span><span class="p">)</span><span class="nx">keyPathsForValuesAffectingFrame</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">[</span><span class="nx">CPSet</span> <span class="nl">setWithObjects:</span><span class="s2">@&quot;frameOrigin&quot;</span><span class="p">,</span> <span class="s2">@&quot;frameSize&quot;</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="nx">init</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">initWithFrame:</span><span class="nf">CGRectMakeZero</span><span class="p">()</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Initializes the receiver for usage with the specified bounding rectangle</span>
<span class="cm">    @return the initialized view</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="nl">initWithFrame:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">aFrame</span>
<span class="p">{</span>
    <span class="k">self</span> <span class="o">=</span> <span class="k">[</span><span class="nx">super</span> <span class="nl">init</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="nx">aFrame</span><span class="p">),</span>
            <span class="nx">height</span> <span class="o">=</span> <span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="nx">aFrame</span><span class="p">);</span>
        
        <span class="nx">_subviews</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">_registeredDraggedTypes</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPSet</span> <span class="nl">set</span><span class="k">]</span><span class="p">;</span>
        <span class="nx">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nx">_tag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="nx">_frame</span> <span class="o">=</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="nx">aFrame</span><span class="p">);</span>
        <span class="nx">_bounds</span> <span class="o">=</span> <span class="nf">_CGRectMake</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>

        <span class="nx">_autoresizingMask</span> <span class="o">=</span> <span class="nx">CPViewNotSizable</span><span class="p">;</span>
        <span class="nx">_autoresizesSubviews</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>
    
        <span class="nx">_opacity</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
        <span class="nx">_isHidden</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>
        <span class="nx">_hitTests</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>

<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
        <span class="nx">_DOMElement</span> <span class="o">=</span> <span class="nx">DOMElementPrototype</span><span class="p">.</span><span class="nf">cloneNode</span><span class="p">(</span><span class="nx">false</span><span class="p">);</span>

        <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">aFrame</span><span class="p">),</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="nx">aFrame</span><span class="p">));</span>
        <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
        
        <span class="nx">_DOMImageParts</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">_DOMImageSizes</span> <span class="o">=</span> <span class="p">[];</span>
<span class="cp">#endif</span>
        
        <span class="nx">_theme</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPTheme</span> <span class="nl">defaultTheme</span><span class="k">]</span><span class="p">;</span>
        <span class="nx">_themeState</span> <span class="o">=</span> <span class="nx">CPThemeStateNormal</span><span class="p">;</span>

        <span class="k">[</span><span class="nx">self</span> <span class="nl">setupViewFlags</span><span class="k">]</span><span class="p">;</span>

        <span class="k">[</span><span class="nx">self</span> <span class="nl">_loadThemeAttributes</span><span class="k">]</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the container view of the receiver</span>
<span class="cm">    @return the receiver&#39;s containing view</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">superview</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_superview</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns an array of all the views contained as direct children of the receiver</span>
<span class="cm">    @return an array of CPViews</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CPArray</span><span class="p">)</span><span class="nx">subviews</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_subviews</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the window containing this receiver</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CPWindow</span><span class="p">)</span><span class="nb">window</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_window</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Makes the argument a subview of the receiver.</span>
<span class="cm">    @param aSubview the CPView to make a subview</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">addSubview:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aSubview</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">_insertSubview:</span><span class="nx">aSubview</span> <span class="nl">atIndex:</span><span class="nx">CPNotFound</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Makes \c aSubview a subview of the receiver. It is positioned relative to \c anotherView</span>
<span class="cm">    @param aSubview the view to add as a subview</span>
<span class="cm">    @param anOrderingMode specifies \c aSubview&#39;s ordering relative to \c anotherView</span>
<span class="cm">    @param anotherView \c aSubview will be positioned relative to this argument</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">addSubview:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aSubview</span> <span class="nl">positioned:</span><span class="p">(</span><span class="nx">CPWindowOrderingMode</span><span class="p">)</span><span class="nx">anOrderingMode</span> <span class="nl">relativeTo:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">anotherView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">anotherView</span> <span class="o">?</span> <span class="k">[</span><span class="nx">_subviews</span> <span class="nl">indexOfObjectIdenticalTo:</span><span class="nx">anotherView</span><span class="k">]</span> <span class="o">:</span> <span class="nx">CPNotFound</span><span class="p">;</span>
    
    <span class="c1">// In other words, if no view, then either all the way at the bottom or all the way at the top.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="nx">CPNotFound</span><span class="p">)</span>
        <span class="nx">index</span> <span class="o">=</span> <span class="p">(</span><span class="nx">anOrderingMode</span> <span class="o">===</span> <span class="nx">CPWindowAbove</span><span class="p">)</span> <span class="o">?</span> <span class="k">[</span><span class="nx">_subviews</span> <span class="nl">count</span><span class="k">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="c1">// else, if we have a view, above if above.</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">anOrderingMode</span> <span class="o">===</span> <span class="nx">CPWindowAbove</span><span class="p">)</span>
        <span class="o">++</span><span class="nx">index</span><span class="p">;</span>
        
    <span class="k">[</span><span class="nx">self</span> <span class="nl">_insertSubview:</span><span class="nx">aSubview</span> <span class="nl">atIndex:</span><span class="nx">index</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* @ignore */</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">_insertSubview:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aSubview</span> <span class="nl">atIndex:</span><span class="p">(</span><span class="kr">int</span><span class="p">)</span><span class="nx">anIndex</span>
<span class="p">{</span>
    <span class="c1">// We will have to adjust the z-index of all views starting at this index.</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">_subviews</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="c1">// dirty the key view loop, in case the window wants to auto recalculate it</span>
    <span class="k">[[</span><span class="nx">self</span> <span class="nl">window</span><span class="k">]</span> <span class="nl">_dirtyKeyViewLoop</span><span class="k">]</span><span class="p">;</span>

    <span class="c1">// If this is already one of our subviews, remove it.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">aSubview</span><span class="p">.</span><span class="nx">_superview</span> <span class="o">==</span> <span class="k">self</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">[</span><span class="nx">_subviews</span> <span class="nl">indexOfObjectIdenticalTo:</span><span class="nx">aSubview</span><span class="k">]</span><span class="p">;</span>
        
        <span class="c1">// FIXME: should this be anIndex &gt;= count? (last one)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="nx">anIndex</span> <span class="o">||</span> <span class="nx">index</span> <span class="o">===</span> <span class="nx">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">anIndex</span> <span class="o">===</span> <span class="nx">count</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        
        <span class="k">[</span><span class="nx">_subviews</span> <span class="nl">removeObjectAtIndex:</span><span class="nx">index</span><span class="k">]</span><span class="p">;</span>
        
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
        <span class="nf">CPDOMDisplayServerRemoveChild</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">aSubview</span><span class="p">.</span><span class="nx">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">anIndex</span> <span class="o">&gt;</span> <span class="nx">index</span><span class="p">)</span>
            <span class="o">--</span><span class="nx">anIndex</span><span class="p">;</span>
        
        <span class="c1">//We&#39;ve effectively made the subviews array shorter, so represent that.</span>
        <span class="o">--</span><span class="nx">count</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// Remove the view from its previous superview.</span>
        <span class="k">[</span><span class="nx">aSubview</span> <span class="nl">removeFromSuperview</span><span class="k">]</span><span class="p">;</span>

        <span class="c1">// Set the subview&#39;s window to our own. </span>
        <span class="k">[</span><span class="nx">aSubview</span> <span class="nl">_setWindow:</span><span class="nx">_window</span><span class="k">]</span><span class="p">;</span>

        <span class="c1">// Notify the subview that it will be moving.</span>
        <span class="k">[</span><span class="nx">aSubview</span> <span class="nl">viewWillMoveToSuperview:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
    
        <span class="c1">// Set ourselves as the superview.</span>
        <span class="nx">aSubview</span><span class="p">.</span><span class="nx">_superview</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">anIndex</span> <span class="o">===</span> <span class="nx">CPNotFound</span> <span class="o">||</span> <span class="nx">anIndex</span> <span class="o">&gt;=</span> <span class="nx">count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">_subviews</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">aSubview</span><span class="p">);</span>

<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span><span class="c1"></span>
<span class="c1">        // Attach the actual node.</span>
        <span class="nf">CPDOMDisplayServerAppendChild</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">aSubview</span><span class="p">.</span><span class="nx">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nx">_subviews</span><span class="p">.</span><span class="nf">splice</span><span class="p">(</span><span class="nx">anIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">aSubview</span><span class="p">);</span>
    
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span><span class="c1"></span>
<span class="c1">        // Attach the actual node.</span>
        <span class="nf">CPDOMDisplayServerInsertBefore</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">aSubview</span><span class="p">.</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">_subviews</span><span class="p">[</span><span class="nx">anIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    
    <span class="k">[</span><span class="nx">aSubview</span> <span class="nl">setNextResponder:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">aSubview</span> <span class="nl">viewDidMoveToSuperview</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">self</span> <span class="nl">didAddSubview:</span><span class="nx">aSubview</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver has added \c aSubview to it&#39;s child views.</span>
<span class="cm">    @param aSubview the view that was added</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">didAddSubview:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aSubview</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Removes the receiver from it&#39;s container view and window.</span>
<span class="cm">    Does nothing if there&#39;s no container view.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">removeFromSuperview</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_superview</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="c1">// dirty the key view loop, in case the window wants to auto recalculate it</span>
    <span class="k">[[</span><span class="nx">self</span> <span class="nl">window</span><span class="k">]</span> <span class="nl">_dirtyKeyViewLoop</span><span class="k">]</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">_superview</span> <span class="nl">willRemoveSubview:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[[</span><span class="nx">_superview</span> <span class="nl">subviews</span><span class="k">]</span> <span class="nl">removeObject:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>

<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
        <span class="nf">CPDOMDisplayServerRemoveChild</span><span class="p">(</span><span class="nx">_superview</span><span class="p">.</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="nx">_superview</span> <span class="o">=</span> <span class="nx">nil</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">self</span> <span class="nl">_setWindow:</span><span class="nx">nil</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Replaces the specified child view with another view</span>
<span class="cm">    @param aSubview the view to replace</span>
<span class="cm">    @param aView the replacement view</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">replaceSubview:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aSubview</span> <span class="kd">with</span><span class="o">:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">aSubview</span><span class="p">.</span><span class="nx">_superview</span> <span class="o">!=</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">[</span><span class="nx">_subviews</span> <span class="nl">indexOfObjectIdenticalTo:</span><span class="nx">aSubview</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">aSubview</span> <span class="nl">removeFromSuperview</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">self</span> <span class="nl">_insertSubview:</span><span class="nx">aView</span> <span class="nl">atIndex:</span><span class="nx">index</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* @ignore */</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">_setWindow:</span><span class="p">(</span><span class="nx">CPWindow</span><span class="p">)</span><span class="nx">aWindow</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_window</span> <span class="o">===</span> <span class="nx">aWindow</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="k">[[</span><span class="nx">self</span> <span class="nl">window</span><span class="k">]</span> <span class="nl">_dirtyKeyViewLoop</span><span class="k">]</span><span class="p">;</span>

    <span class="c1">// Clear out first responder if we&#39;re the first responder and leaving.</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">_window</span> <span class="nl">firstResponder</span><span class="k">]</span> <span class="o">===</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">_window</span> <span class="nl">makeFirstResponder:</span><span class="nx">nil</span><span class="k">]</span><span class="p">;</span>

    <span class="c1">// Notify the view and its subviews</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">viewWillMoveToWindow:</span><span class="nx">aWindow</span><span class="k">]</span><span class="p">;</span>

    <span class="c1">// Unregister the drag events from the current window and register</span>
    <span class="c1">// them in the new window.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_registeredDraggedTypes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">[</span><span class="nx">_window</span> <span class="nl">_noteUnregisteredDraggedTypes:</span><span class="nx">_registeredDraggedTypes</span><span class="k">]</span><span class="p">;</span>
        <span class="k">[</span><span class="nx">aWindow</span> <span class="nl">_noteRegisteredDraggedTypes:</span><span class="nx">_registeredDraggedTypes</span><span class="k">]</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">_window</span> <span class="o">=</span> <span class="nx">aWindow</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">[</span><span class="nx">_subviews</span> <span class="nl">count</span><span class="k">]</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">_subviews</span><span class="p">[</span><span class="nx">count</span><span class="p">]</span> <span class="nl">_setWindow:</span><span class="nx">aWindow</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">self</span> <span class="nl">viewDidMoveToWindow</span><span class="k">]</span><span class="p">;</span>

    <span class="k">[[</span><span class="nx">self</span> <span class="nl">window</span><span class="k">]</span> <span class="nl">_dirtyKeyViewLoop</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver is, or is a descendant of, \c aView.</span>
<span class="cm">    @param aView the view to test for ancestry</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nl">isDescendantOf:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
    
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">view</span> <span class="o">==</span> <span class="nx">aView</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
    <span class="p">}</span> <span class="nf">while</span><span class="p">(</span><span class="nx">view</span> <span class="o">=</span> <span class="k">[</span><span class="nx">view</span> <span class="nl">superview</span><span class="k">]</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver&#39;s superview has changed.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">viewDidMoveToSuperview</span>
<span class="p">{</span>
<span class="c1">//    if (_graphicsContext)</span>
        <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsDisplay:</span><span class="nx">YES</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver has been moved to a new CPWindow.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">viewDidMoveToWindow</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver is about to be moved to a new view.</span>
<span class="cm">    @param aView the view to which the receiver will be moved</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">viewWillMoveToSuperview:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver is about to be moved to a new window.</span>
<span class="cm">    @param aWindow the window to which the receiver will be moved.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">viewWillMoveToWindow:</span><span class="p">(</span><span class="nx">CPWindow</span><span class="p">)</span><span class="nx">aWindow</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver is about to be remove one of its subviews.</span>
<span class="cm">    @param aView the view that will be removed</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">willRemoveSubview:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the menu item containing the receiver or one of its ancestor views.</span>
<span class="cm">    @return a menu item, or \c nil if the view or one of its ancestors wasn&#39;t found</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CPMenuItem</span><span class="p">)</span><span class="nx">enclosingMenuItem</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="nx">view</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">[</span><span class="nx">view</span> <span class="nl">isKindOfClass:</span><span class="k">[</span><span class="nx">_CPMenuItemView</span> <span class="nl">class</span><span class="k">]]</span><span class="p">)</span>
        <span class="nx">view</span> <span class="o">=</span> <span class="k">[</span><span class="nx">view</span> <span class="nl">superview</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_menuItem</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="nx">nil</span><span class="p">;</span>
<span class="cm">/*    var view = self,</span>
<span class="cm">        enclosingMenuItem = _enclosingMenuItem;</span>
<span class="cm">    </span>
<span class="cm">    while (!enclosingMenuItem &amp;&amp; (view = view._enclosingMenuItem))</span>
<span class="cm">        view = [view superview];</span>
<span class="cm">    </span>
<span class="cm">    return enclosingMenuItem;*/</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setTag:</span><span class="p">(</span><span class="nx">CPInteger</span><span class="p">)</span><span class="nx">aTag</span>
<span class="p">{</span>
    <span class="nx">_tag</span> <span class="o">=</span> <span class="nx">aTag</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CPInteger</span><span class="p">)</span><span class="nx">tag</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">viewWithTag:</span><span class="p">(</span><span class="nx">CPInteger</span><span class="p">)</span><span class="nx">aTag</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">self</span> <span class="nl">tag</span><span class="k">]</span> <span class="o">===</span> <span class="nx">aTag</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">self</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">count</span> <span class="o">=</span> <span class="nx">_subviews</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="o">++</span><span class="nx">index</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">[</span><span class="nx">_subviews</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="nl">viewWithTag:</span><span class="nx">aTag</span><span class="k">]</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">view</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns whether the view is flipped.</span>
<span class="cm">    @return \c YES if the view is flipped. \c NO, otherwise.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">isFlipped</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the frame size of the receiver to the dimensions and origin of the provided rectangle in the coordinate system</span>
<span class="cm">    of the superview. The method also posts an CPViewFrameDidChangeNotification to the notification</span>
<span class="cm">    center if the receiver is configured to do so. If the frame is the same as the current frame, the method simply</span>
<span class="cm">    returns (and no notificaion is posted).</span>
<span class="cm">    @param aFrame the rectangle specifying the new origin and size  of the receiver</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setFrame:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">aFrame</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectEqualToRect</span><span class="p">(</span><span class="nx">_frame</span><span class="p">,</span> <span class="nx">aFrame</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>
        
    <span class="nx">_inhibitFrameAndBoundsChangedNotifications</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setFrameOrigin:</span><span class="nx">aFrame</span><span class="p">.</span><span class="nx">origin</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setFrameSize:</span><span class="nx">aFrame</span><span class="p">.</span><span class="nx">size</span><span class="k">]</span><span class="p">;</span>

    <span class="nx">_inhibitFrameAndBoundsChangedNotifications</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsFrameChangedNotifications</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">CachedNotificationCenter</span> <span class="nl">postNotificationName:</span><span class="nx">CPViewFrameDidChangeNotification</span> <span class="nl">object:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the receiver&#39;s frame.</span>
<span class="cm">    @return a copy of the receiver&#39;s frame</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">frame</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="nx">_frame</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">frameOrigin</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGPointMakeCopy</span><span class="p">(</span><span class="nx">_frame</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nx">frameSize</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGSizeMakeCopy</span><span class="p">(</span><span class="nx">_frame</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Moves the center of the receiver&#39;s frame to the provided point. The point is defined in the superview&#39;s coordinate system. </span>
<span class="cm">    The method posts a CPViewFrameDidChangeNotification to the default notification center if the receiver </span>
<span class="cm">    is configured to do so. If the specified origin is the same as the frame&#39;s current origin, the method will </span>
<span class="cm">    simply return (and no notification will be posted).</span>
<span class="cm">    @param aPoint the new origin point</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setCenter:</span><span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">aPoint</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setFrameOrigin:</span><span class="nf">CGPointMake</span><span class="p">(</span><span class="nx">aPoint</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">_frame</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">_frame</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span><span class="k">]</span><span class="p">;</span> 
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the center of the receiver&#39;s frame to the provided point. The point is defined in the superview&#39;s coordinate system. </span>
<span class="cm">    @return CGPoint the center point of the receiver&#39;s frame</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">center</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGPointMake</span><span class="p">(</span><span class="nx">_frame</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="nx">_frame</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">_frame</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="nx">_frame</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s frame origin to the provided point. The point is defined in the superview&#39;s coordinate system. </span>
<span class="cm">    The method posts a CPViewFrameDidChangeNotification to the default notification center if the receiver </span>
<span class="cm">    is configured to do so. If the specified origin is the same as the frame&#39;s current origin, the method will </span>
<span class="cm">    simply return (and no notification will be posted).</span>
<span class="cm">    @param aPoint the new origin point</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setFrameOrigin:</span><span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">aPoint</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">origin</span> <span class="o">=</span> <span class="nx">_frame</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aPoint</span> <span class="o">||</span> <span class="nf">_CGPointEqualToPoint</span><span class="p">(</span><span class="nx">origin</span><span class="p">,</span> <span class="nx">aPoint</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsFrameChangedNotifications</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">CachedNotificationCenter</span> <span class="nl">postNotificationName:</span><span class="nx">CPViewFrameDidChangeNotification</span> <span class="nl">object:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>

<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">transform</span> <span class="o">=</span> <span class="nx">_superview</span> <span class="o">?</span> <span class="nx">_superview</span><span class="p">.</span><span class="nx">_boundsTransform</span> <span class="o">:</span> <span class="nx">NULL</span><span class="p">;</span>

    <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">transform</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s frame size. If \c aSize is the same as the frame&#39;s current dimensions, this</span>
<span class="cm">    method simply returns. The method posts a CPViewFrameDidChangeNotification to the</span>
<span class="cm">    default notification center if the receiver is configured to do so.</span>
<span class="cm">    @param aSize the new size for the frame</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setFrameSize:</span><span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nx">aSize</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">_frame</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aSize</span> <span class="o">||</span> <span class="nf">_CGSizeEqualToSize</span><span class="p">(</span><span class="nx">size</span><span class="p">,</span> <span class="nx">aSize</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">oldSize</span> <span class="o">=</span> <span class="nf">_CGSizeMakeCopy</span><span class="p">(</span><span class="nx">size</span><span class="p">);</span>

    <span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">aSize</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">aSize</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="kc">YES</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">_bounds</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">aSize</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
        <span class="nx">_bounds</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">aSize</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_layer</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">_layer</span> <span class="nl">_owningViewBoundsChanged</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_autoresizesSubviews</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">self</span> <span class="nl">resizeSubviewsWithOldSize:</span><span class="nx">oldSize</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsLayout</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsDisplay:</span><span class="nx">YES</span><span class="k">]</span><span class="p">;</span>

<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
    <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_DOMContentsElement</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">CPDOMDisplayServerSetSize</span><span class="p">(</span><span class="nx">_DOMContentsElement</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
        <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMContentsElement</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundType</span> <span class="o">!==</span> <span class="nx">BackgroundTrivialColor</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">images</span> <span class="o">=</span> <span class="k">[[</span><span class="nx">_backgroundColor</span> <span class="nl">patternImage</span><span class="k">]</span> <span class="nl">imageSlices</span><span class="k">]</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundType</span> <span class="o">===</span> <span class="nx">BackgroundVerticalThreePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundType</span> <span class="o">===</span> <span class="nx">BackgroundHorizontalThreePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundType</span> <span class="o">===</span> <span class="nx">BackgroundNinePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span>
                <span class="nx">height</span> <span class="o">=</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="nx">height</span><span class="p">;</span>

            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsFrameChangedNotifications</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">CachedNotificationCenter</span> <span class="nl">postNotificationName:</span><span class="nx">CPViewFrameDidChangeNotification</span> <span class="nl">object:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s bounds. The bounds define the size and location of the receiver inside it&#39;s frame. Posts a </span>
<span class="cm">    CPViewBoundsDidChangeNotification to the default notification center if the receiver is configured to do so.</span>
<span class="cm">    @param bounds the new bounds</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setBounds:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">bounds</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectEqualToRect</span><span class="p">(</span><span class="nx">_bounds</span><span class="p">,</span> <span class="nx">bounds</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>
        
    <span class="nx">_inhibitFrameAndBoundsChangedNotifications</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setBoundsOrigin:</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">origin</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setBoundsSize:</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">size</span><span class="k">]</span><span class="p">;</span>

    <span class="nx">_inhibitFrameAndBoundsChangedNotifications</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsBoundsChangedNotifications</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">CachedNotificationCenter</span> <span class="nl">postNotificationName:</span><span class="nx">CPViewBoundsDidChangeNotification</span> <span class="nl">object:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the receiver&#39;s bounds. The bounds define the size</span>
<span class="cm">    and location of the receiver inside its frame.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">bounds</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="nx">_bounds</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the location of the receiver inside its frame. The method</span>
<span class="cm">    posts a CPViewBoundsDidChangeNotification to the</span>
<span class="cm">    default notification center if the receiver is configured to do so.</span>
<span class="cm">    @param aPoint the new location for the receiver</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setBoundsOrigin:</span><span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">aPoint</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">origin</span> <span class="o">=</span> <span class="nx">_bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGPointEqualToPoint</span><span class="p">(</span><span class="nx">origin</span><span class="p">,</span> <span class="nx">aPoint</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>
        
    <span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">_boundsTransform</span> <span class="o">=</span> <span class="nf">_CGAffineTransformMakeTranslation</span><span class="p">(</span><span class="o">-</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="o">-</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
        <span class="nx">_inverseBoundsTransform</span> <span class="o">=</span> <span class="nf">CGAffineTransformInvert</span><span class="p">(</span><span class="nx">_boundsTransform</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nx">_boundsTransform</span> <span class="o">=</span> <span class="nx">nil</span><span class="p">;</span>
        <span class="nx">_inverseBoundsTransform</span> <span class="o">=</span> <span class="nx">nil</span><span class="p">;</span>
    <span class="p">}</span>
    
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">_subviews</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="nx">index</span><span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">_subviews</span><span class="p">[</span><span class="nx">index</span><span class="p">],</span>
            <span class="nx">origin</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_frame</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
        
        <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">_boundsTransform</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsBoundsChangedNotifications</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">CachedNotificationCenter</span> <span class="nl">postNotificationName:</span><span class="nx">CPViewBoundsDidChangeNotification</span> <span class="nl">object:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s size inside its frame. The method posts a</span>
<span class="cm">    CPViewBoundsDidChangeNotification to the default</span>
<span class="cm">    notification center if the receiver is configured to do so.</span>
<span class="cm">    @param aSize the new size for the receiver</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setBoundsSize:</span><span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nx">aSize</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">_bounds</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGSizeEqualToSize</span><span class="p">(</span><span class="nx">size</span><span class="p">,</span> <span class="nx">aSize</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">frameSize</span> <span class="o">=</span> <span class="nx">_frame</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">_CGSizeEqualToSize</span><span class="p">(</span><span class="nx">size</span><span class="p">,</span> <span class="nx">frameSize</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">origin</span> <span class="o">=</span> <span class="nx">_bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
        
        <span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">/=</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
        <span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">/=</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">aSize</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">aSize</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">_CGSizeEqualToSize</span><span class="p">(</span><span class="nx">size</span><span class="p">,</span> <span class="nx">frameSize</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">origin</span> <span class="o">=</span> <span class="nx">_bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
        
        <span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
        <span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsBoundsChangedNotifications</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">CachedNotificationCenter</span> <span class="nl">postNotificationName:</span><span class="nx">CPViewBoundsDidChangeNotification</span> <span class="nl">object:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*!</span>
<span class="cm">    Notifies subviews that the superview changed size.</span>
<span class="cm">    @param aSize the size of the old superview</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">resizeWithOldSuperviewSize:</span><span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nx">aSize</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mask</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">autoresizingMask</span><span class="k">]</span><span class="p">;</span>
    
    <span class="nf">if</span><span class="p">(</span><span class="nx">mask</span> <span class="o">==</span> <span class="nx">CPViewNotSizable</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="nx">_superview</span><span class="p">.</span><span class="nx">_frame</span><span class="p">,</span>
        <span class="nx">newFrame</span> <span class="o">=</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="nx">_frame</span><span class="p">),</span>
        <span class="nx">dX</span> <span class="o">=</span> <span class="p">(</span><span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="o">-</span> <span class="nx">aSize</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="o">/</span>
            <span class="p">(((</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewMinXMargin</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewWidthSizable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewMaxXMargin</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)),</span>
        <span class="nx">dY</span> <span class="o">=</span> <span class="p">(</span><span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="o">-</span> <span class="nx">aSize</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="o">/</span>
            <span class="p">((</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewMinYMargin</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewHeightSizable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewMaxYMargin</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewMinXMargin</span><span class="p">)</span>
        <span class="nx">newFrame</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">dX</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewWidthSizable</span><span class="p">)</span>
        <span class="nx">newFrame</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">+=</span> <span class="nx">dX</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewMinYMargin</span><span class="p">)</span>
        <span class="nx">newFrame</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">dY</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mask</span> <span class="o">&amp;</span> <span class="nx">CPViewHeightSizable</span><span class="p">)</span>
        <span class="nx">newFrame</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="nx">dY</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">self</span> <span class="nl">setFrame:</span><span class="nx">newFrame</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Initiates \c -superviewSizeChanged: messages to subviews.</span>
<span class="cm">    @param aSize the size for the subviews</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">resizeSubviewsWithOldSize:</span><span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nx">aSize</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">_subviews</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">_subviews</span><span class="p">[</span><span class="nx">count</span><span class="p">]</span> <span class="nl">resizeWithOldSuperviewSize:</span><span class="nx">aSize</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Specifies whether the receiver view should automatically resize its</span>
<span class="cm">    subviews when its \c -setFrameSize: method receives a change.</span>
<span class="cm">    @param aFlag If \c YES, then subviews will automatically be resized</span>
<span class="cm">    when this view is resized. \c NO means the views will not</span>
<span class="cm">    be resized automatically.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setAutoresizesSubviews:</span><span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">aFlag</span>
<span class="p">{</span>
    <span class="nx">_autoresizesSubviews</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">aFlag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Reports whether the receiver automatically resizes its subviews when its frame size changes.</span>
<span class="cm">    @return \c YES means it resizes its subviews on a frame size change.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">autoresizesSubviews</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_autoresizesSubviews</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Determines automatic resizing behavior.</span>
<span class="cm">    @param aMask a bit mask with options</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setAutoresizingMask:</span><span class="p">(</span><span class="nx">unsigned</span><span class="p">)</span><span class="nx">aMask</span>
<span class="p">{</span>
    <span class="nx">_autoresizingMask</span> <span class="o">=</span> <span class="nx">aMask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the bit mask options for resizing behavior</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">unsigned</span><span class="p">)</span><span class="nx">autoresizingMask</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_autoresizingMask</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Fullscreen Mode</span>

<span class="cm">/*!</span>
<span class="cm">    Puts the receiver into full screen mode.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">enterFullScreenMode</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">enterFullScreenMode:</span><span class="nx">nil</span> <span class="nl">withOptions:</span><span class="nx">nil</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Puts the receiver into full screen mode.</span>
<span class="cm">    @param aScreen the that should be used</span>
<span class="cm">    @param options configuration options</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nl">enterFullScreenMode:</span><span class="p">(</span><span class="nx">CPScreen</span><span class="p">)</span><span class="nx">aScreen</span> <span class="nl">withOptions:</span><span class="p">(</span><span class="nx">CPDictionary</span><span class="p">)</span><span class="nx">options</span>
<span class="p">{</span>
    <span class="nx">_fullScreenModeState</span> <span class="o">=</span> <span class="nf">_CPViewFullScreenModeStateMake</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="nx">fullScreenWindow</span> <span class="o">=</span> <span class="k">[[</span><span class="nx">CPWindow</span> <span class="nl">alloc</span><span class="k">]</span> <span class="nl">initWithContentRect:</span><span class="k">[[</span><span class="nx">CPPlatformWindow</span> <span class="nl">primaryPlatformWindow</span><span class="k">]</span> <span class="nl">contentBounds</span><span class="k">]</span> <span class="nl">styleMask:</span><span class="nx">CPBorderlessWindowMask</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">fullScreenWindow</span> <span class="nl">setLevel:</span><span class="nx">CPScreenSaverWindowLevel</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">fullScreenWindow</span> <span class="nl">setAutoresizingMask:</span><span class="nx">CPViewWidthSizable</span> <span class="o">|</span> <span class="nx">CPViewHeightSizable</span><span class="k">]</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="nx">contentView</span> <span class="o">=</span> <span class="k">[</span><span class="nx">fullScreenWindow</span> <span class="nl">contentView</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">contentView</span> <span class="nl">setBackgroundColor:</span><span class="k">[</span><span class="nx">CPColor</span> <span class="nl">blackColor</span><span class="k">]]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">contentView</span> <span class="nl">addSubview:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">self</span> <span class="nl">setAutoresizingMask:</span><span class="nx">CPViewWidthSizable</span> <span class="o">|</span> <span class="nx">CPViewHeightSizable</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setFrame:</span><span class="nf">CGRectMakeCopy</span><span class="p">(</span><span class="k">[</span><span class="nx">contentView</span> <span class="nl">bounds</span><span class="k">]</span><span class="p">)</span><span class="k">]</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">fullScreenWindow</span> <span class="nl">makeKeyAndOrderFront:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">fullScreenWindow</span> <span class="nl">makeFirstResponder:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
    
    <span class="nx">_isInFullScreenMode</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    The receiver should exit full screen mode.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">exitFullScreenMode</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">exitFullScreenModeWithOptions:</span><span class="nx">nil</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    The receiver should exit full screen mode.</span>
<span class="cm">    @param options configurations options</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">exitFullScreenModeWithOptions:</span><span class="p">(</span><span class="nx">CPDictionary</span><span class="p">)</span><span class="nx">options</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_isInFullScreenMode</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="nx">_isInFullScreenMode</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">self</span> <span class="nl">setFrame:</span><span class="nx">_fullScreenModeState</span><span class="p">.</span><span class="nx">frame</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setAutoresizingMask:</span><span class="nx">_fullScreenModeState</span><span class="p">.</span><span class="nx">autoresizingMask</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">_fullScreenModeState</span><span class="p">.</span><span class="nx">superview</span> <span class="nl">_insertSubview:</span><span class="nx">self</span> <span class="nl">atIndex:</span><span class="nx">_fullScreenModeState</span><span class="p">.</span><span class="nx">index</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[[</span><span class="nx">self</span> <span class="nl">window</span><span class="k">]</span> <span class="nl">orderOut:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver is currently in full screen mode.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">isInFullScreenMode</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_isInFullScreenMode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets whether the receiver should be hidden.</span>
<span class="cm">    @param aFlag \c YES makes the receiver hidden.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setHidden:</span><span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">aFlag</span>
<span class="p">{</span>
    <span class="nx">aFlag</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">aFlag</span><span class="p">;</span>

    <span class="nf">if</span><span class="p">(</span><span class="nx">_isHidden</span> <span class="o">===</span> <span class="nx">aFlag</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

<span class="c1">//  FIXME: Should we return to visibility?  This breaks in FireFox, Opera, and IE.</span>
<span class="c1">//    _DOMElement.style.visibility = (_isHidden = aFlag) ? &quot;hidden&quot; : &quot;visible&quot;;</span>
    <span class="nx">_isHidden</span> <span class="o">=</span> <span class="nx">aFlag</span><span class="p">;</span>
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
    <span class="nx">_DOMElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="nx">_isHidden</span> <span class="o">?</span> <span class="s2">&quot;none&quot;</span> <span class="o">:</span> <span class="s2">&quot;block&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">aFlag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">[</span><span class="nx">_window</span> <span class="nl">firstResponder</span><span class="k">]</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">view</span> <span class="nl">isKindOfClass:</span><span class="k">[</span><span class="nx">CPView</span> <span class="nl">class</span><span class="k">]]</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">do</span> 
            <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="k">self</span> <span class="o">==</span> <span class="nx">view</span><span class="p">)</span>
               <span class="p">{</span>
                  <span class="k">[</span><span class="nx">_window</span> <span class="nl">makeFirstResponder:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">nextValidKeyView</span><span class="k">]]</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span>
               <span class="p">}</span>   
            <span class="p">}</span> 
            <span class="k">while</span> <span class="p">(</span><span class="nx">view</span> <span class="o">=</span> <span class="k">[</span><span class="nx">view</span> <span class="nl">superview</span><span class="k">]</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver is hidden.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">isHidden</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_isHidden</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the opacity of the receiver. The value must be in the range of 0.0 to 1.0, where 0.0 is </span>
<span class="cm">    completely transparent and 1.0 is completely opaque.</span>
<span class="cm">    @param anAlphaValue an alpha value ranging from 0.0 to 1.0.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setAlphaValue:</span><span class="p">(</span><span class="kr">float</span><span class="p">)</span><span class="nx">anAlphaValue</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_opacity</span> <span class="o">==</span> <span class="nx">anAlphaValue</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="nx">_opacity</span> <span class="o">=</span> <span class="nx">anAlphaValue</span><span class="p">;</span>
    
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nf">CPFeatureIsCompatible</span><span class="p">(</span><span class="nx">CPOpacityRequiresFilterFeature</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">anAlphaValue</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">try</span> <span class="p">{</span> <span class="nx">_DOMElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nf">removeAttribute</span><span class="p">(</span><span class="s2">&quot;filter&quot;</span><span class="p">)</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">anException</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
        <span class="k">else</span>
            <span class="nx">_DOMElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="s2">&quot;alpha(opacity=&quot;</span> <span class="o">+</span> <span class="nx">anAlphaValue</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="nx">_DOMElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">anAlphaValue</span><span class="p">;</span>

<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the alpha value of the receiver. Ranges from 0.0 to</span>
<span class="cm">    1.0, where 0.0 is completely transparent and 1.0 is completely opaque.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="kr">float</span><span class="p">)</span><span class="nx">alphaValue</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_opacity</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver is hidden, or one</span>
<span class="cm">    of it&#39;s ancestor views is hidden. \c NO, otherwise.</span>
<span class="cm">*/</span>   
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">isHiddenOrHasHiddenAncestor</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="nx">view</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">[</span><span class="nx">view</span> <span class="nl">isHidden</span><span class="k">]</span><span class="p">)</span>
        <span class="nx">view</span> <span class="o">=</span> <span class="k">[</span><span class="nx">view</span> <span class="nl">superview</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="nx">view</span> <span class="o">!==</span> <span class="nx">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns whether the receiver should be sent a \c -mouseDown: message for \c anEvent.&lt;br/&gt;</span>
<span class="cm">    Returns \c YES by default.</span>
<span class="cm">    @return \c YES, if the view object accepts first mouse-down event. \c NO, otherwise.</span>
<span class="cm">*/</span>
<span class="c1">//FIXME: should be NO by default? </span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nl">acceptsFirstMouse:</span><span class="p">(</span><span class="nx">CPEvent</span><span class="p">)</span><span class="nx">anEvent</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns whether or not the view responds to hit tests.</span>
<span class="cm">    @return \c YES if this view listens to \c -hitTest messages, \c NO otherwise.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">hitTests</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_hitTests</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Set whether or not the view should respond to hit tests.</span>
<span class="cm">    @param shouldHitTest should be \c YES if this view should respond to hit tests, \c NO otherwise.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setHitTests:</span><span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">shouldHitTest</span>
<span class="p">{</span>
    <span class="nx">_hitTests</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">shouldHitTest</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Tests whether a point is contained within this view, or one of its subviews.</span>
<span class="cm">    @param aPoint the point to test</span>
<span class="cm">    @return returns the containing view, or nil if the point is not contained</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nl">hitTest:</span><span class="p">(</span><span class="nx">CPPoint</span><span class="p">)</span><span class="nx">aPoint</span>
<span class="p">{</span>
    <span class="nf">if</span><span class="p">(</span><span class="nx">_isHidden</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_hitTests</span> <span class="o">||</span> <span class="o">!</span><span class="nf">CPRectContainsPoint</span><span class="p">(</span><span class="nx">_frame</span><span class="p">,</span> <span class="nx">aPoint</span><span class="p">))</span>
        <span class="k">return</span> <span class="nx">nil</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">nil</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">_subviews</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">adjustedPoint</span> <span class="o">=</span> <span class="nf">_CGPointMake</span><span class="p">(</span><span class="nx">aPoint</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">_frame</span><span class="p">),</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="nx">_frame</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_inverseBoundsTransform</span><span class="p">)</span>
        <span class="nx">adjustedPoint</span> <span class="o">=</span> <span class="nf">_CGPointApplyAffineTransform</span><span class="p">(</span><span class="nx">adjustedPoint</span><span class="p">,</span> <span class="nx">_inverseBoundsTransform</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">view</span> <span class="o">=</span> <span class="k">[</span><span class="nx">_subviews</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="nl">hitTest:</span><span class="nx">adjustedPoint</span><span class="k">]</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">view</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if mouse events aren&#39;t needed by the receiver and can be sent to the superview. The</span>
<span class="cm">    default implementation returns \c NO if the view is opaque.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">mouseDownCanMoveWindow</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">[</span><span class="nx">self</span> <span class="nl">isOpaque</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">mouseDown:</span><span class="p">(</span><span class="nx">CPEvent</span><span class="p">)</span><span class="nx">anEvent</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">self</span> <span class="nl">mouseDownCanMoveWindow</span><span class="k">]</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">super</span> <span class="nl">mouseDown:</span><span class="nx">anEvent</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the background color of the receiver.</span>
<span class="cm">    @param aColor the new color for the receiver&#39;s background</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setBackgroundColor:</span><span class="p">(</span><span class="nx">CPColor</span><span class="p">)</span><span class="nx">aColor</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundColor</span> <span class="o">==</span> <span class="nx">aColor</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="nx">_backgroundColor</span> <span class="o">=</span> <span class="nx">aColor</span><span class="p">;</span>
    
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">patternImage</span> <span class="o">=</span> <span class="k">[</span><span class="nx">_backgroundColor</span> <span class="nl">patternImage</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">patternImage</span> <span class="nl">isThreePartImage</span><span class="k">]</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">_backgroundType</span> <span class="o">=</span> <span class="k">[</span><span class="nx">patternImage</span> <span class="nl">isVertical</span><span class="k">]</span> <span class="o">?</span> <span class="nx">BackgroundVerticalThreePartImage</span> <span class="o">:</span> <span class="nx">BackgroundHorizontalThreePartImage</span><span class="p">;</span>
        
        <span class="nx">amount</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="nx">_DOMImageParts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">patternImage</span> <span class="nl">isNinePartImage</span><span class="k">]</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">_backgroundType</span> <span class="o">=</span> <span class="nx">BackgroundNinePartImage</span><span class="p">;</span>
        
        <span class="nx">amount</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">-</span> <span class="nx">_DOMImageParts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>   
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nx">_backgroundType</span> <span class="o">=</span> <span class="nx">BackgroundTrivialColor</span><span class="p">;</span>

        <span class="nx">amount</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="nx">_DOMImageParts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">amount</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">DOMElement</span> <span class="o">=</span> <span class="nx">DOMElementPrototype</span><span class="p">.</span><span class="nf">cloneNode</span><span class="p">(</span><span class="nx">false</span><span class="p">);</span>
            
            <span class="nx">DOMElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
            
            <span class="nx">_DOMImageParts</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">DOMElement</span><span class="p">);</span>
            <span class="nx">_DOMElement</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">DOMElement</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nx">amount</span> <span class="o">=</span> <span class="o">-</span><span class="nx">amount</span><span class="p">;</span>
        
        <span class="k">while</span> <span class="p">(</span><span class="nx">amount</span><span class="o">--</span><span class="p">)</span>
            <span class="nx">_DOMElement</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">.</span><span class="nf">pop</span><span class="p">());</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundType</span> <span class="o">==</span> <span class="nx">BackgroundTrivialColor</span><span class="p">)</span>
    
        <span class="c1">// Opera doesn&#39;t like DOM properties set to nil.</span>
        <span class="c1">// https://trac.280north.com/ticket/7</span>
        <span class="nx">_DOMElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="nx">_backgroundColor</span> <span class="o">?</span> <span class="k">[</span><span class="nx">_backgroundColor</span> <span class="nl">cssString</span><span class="k">]</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">slices</span> <span class="o">=</span> <span class="k">[</span><span class="nx">patternImage</span> <span class="nl">imageSlices</span><span class="k">]</span><span class="p">,</span>
            <span class="nx">count</span> <span class="o">=</span> <span class="nf">MIN</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">slices</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span>
            <span class="nx">frameSize</span> <span class="o">=</span> <span class="nx">_frame</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">slices</span><span class="p">[</span><span class="nx">count</span><span class="p">],</span>
                <span class="nx">size</span> <span class="o">=</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="nx">count</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image</span> <span class="o">?</span> <span class="k">[</span><span class="nx">image</span> <span class="nl">size</span><span class="k">]</span> <span class="o">:</span> <span class="nf">_CGSizeMakeZero</span><span class="p">();</span>
            
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="nx">count</span><span class="p">],</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>

            <span class="nx">_DOMImageParts</span><span class="p">[</span><span class="nx">count</span><span class="p">].</span><span class="nx">style</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="nx">image</span> <span class="o">?</span> <span class="s2">&quot;url(\&quot;&quot;</span> <span class="o">+</span> <span class="k">[</span><span class="nx">image</span> <span class="nl">filename</span><span class="k">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot;)&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundType</span> <span class="o">==</span> <span class="nx">BackgroundNinePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span>
                <span class="nx">height</span> <span class="o">=</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="nx">height</span><span class="p">;</span>
            
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
                
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>            
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleRightTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleRightTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftBottom</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftBottom</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleRightBottom</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>      
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundType</span> <span class="o">==</span> <span class="nx">BackgroundVerticalThreePartImage</span><span class="p">)</span>
        <span class="p">{</span>    
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
            
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>        
            <span class="nf">CPDOMDisplayServerSetStyleLeftBottom</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundType</span> <span class="o">==</span> <span class="nx">BackgroundHorizontalThreePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">frameSize</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
        
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>        
            <span class="nf">CPDOMDisplayServerSetStyleRightTop</span><span class="p">(</span><span class="nx">_DOMImageParts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the background color of the receiver</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CPColor</span><span class="p">)</span><span class="nx">backgroundColor</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_backgroundColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Converting Coordinates</span>
<span class="cm">/*!</span>
<span class="cm">    Converts \c aPoint from the coordinate space of \c aView to the coordinate space of the receiver.</span>
<span class="cm">    @param aPoint the point to convert</span>
<span class="cm">    @param aView the view space to convert from</span>
<span class="cm">    @return the converted point</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nl">convertPoint:</span><span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">aPoint</span> <span class="nl">fromView:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGPointApplyAffineTransform</span><span class="p">(</span><span class="nx">aPoint</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="nx">aView</span><span class="p">,</span> <span class="nx">self</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Converts \c aPoint from the receiver&#39;s coordinate space to the coordinate space of \c aView.</span>
<span class="cm">    @param aPoint the point to convert</span>
<span class="cm">    @param aView the coordinate space to which the point will be converted</span>
<span class="cm">    @return the converted point</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nl">convertPoint:</span><span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">aPoint</span> <span class="nl">toView:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGPointApplyAffineTransform</span><span class="p">(</span><span class="nx">aPoint</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">aView</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Convert&#39;s \c aSize from \c aView&#39;s coordinate space to the receiver&#39;s coordinate space.</span>
<span class="cm">    @param aSize the size to convert</span>
<span class="cm">    @param aView the coordinate space to convert from</span>
<span class="cm">    @return the converted size</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nl">convertSize:</span><span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nx">aSize</span> <span class="nl">fromView:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGSizeApplyAffineTransform</span><span class="p">(</span><span class="nx">aSize</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="nx">aView</span><span class="p">,</span> <span class="nx">self</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Convert&#39;s \c aSize from the receiver&#39;s coordinate space to \c aView&#39;s coordinate space.</span>
<span class="cm">    @param aSize the size to convert</span>
<span class="cm">    @param the coordinate space to which the size will be converted</span>
<span class="cm">    @return the converted size</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nl">convertSize:</span><span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nx">aSize</span> <span class="nl">toView:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGSizeApplyAffineTransform</span><span class="p">(</span><span class="nx">aSize</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">aView</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Converts \c aRect from \c aView&#39;s coordinate space to the receiver&#39;s space.</span>
<span class="cm">    @param aRect the rectangle to convert</span>
<span class="cm">    @param aView the coordinate space from which to convert</span>
<span class="cm">    @return the converted rectangle</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nl">convertRect:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">aRect</span> <span class="nl">fromView:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGRectApplyAffineTransform</span><span class="p">(</span><span class="nx">aRect</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="nx">aView</span><span class="p">,</span> <span class="nx">self</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Converts \c aRect from the receiver&#39;s coordinate space to \c aView&#39;s coordinate space.</span>
<span class="cm">    @param aRect the rectangle to convert</span>
<span class="cm">    @param aView the coordinate space to which the rectangle will be converted</span>
<span class="cm">    @return the converted rectangle</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nl">convertRect:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">aRect</span> <span class="nl">toView:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGRectApplyAffineTransform</span><span class="p">(</span><span class="nx">aRect</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">aView</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets whether the receiver posts a CPViewFrameDidChangeNotification notification</span>
<span class="cm">    to the default notification center when its frame is changed. The default is \c NO.</span>
<span class="cm">    Methods that could cause a frame change notification are:</span>
<span class="cm">&lt;pre&gt;</span>
<span class="cm">setFrame:</span>
<span class="cm">setFrameSize:</span>
<span class="cm">setFrameOrigin:</span>
<span class="cm">&lt;/pre&gt;</span>
<span class="cm">    @param shouldPostFrameChangedNotifications \c YES makes the receiver post</span>
<span class="cm">    notifications on frame changes (size or origin)</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setPostsFrameChangedNotifications:</span><span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">shouldPostFrameChangedNotifications</span>
<span class="p">{</span>
    <span class="nx">shouldPostFrameChangedNotifications</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">shouldPostFrameChangedNotifications</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsFrameChangedNotifications</span> <span class="o">===</span> <span class="nx">shouldPostFrameChangedNotifications</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="nx">_postsFrameChangedNotifications</span> <span class="o">=</span> <span class="nx">shouldPostFrameChangedNotifications</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsFrameChangedNotifications</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">CachedNotificationCenter</span> <span class="nl">postNotificationName:</span><span class="nx">CPViewFrameDidChangeNotification</span> <span class="nl">object:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver posts a CPViewFrameDidChangeNotification if its frame is changed.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">postsFrameChangedNotifications</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_postsFrameChangedNotifications</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets whether the receiver posts a CPViewBoundsDidChangeNotification notification</span>
<span class="cm">    to the default notification center when its bounds is changed. The default is \c NO.</span>
<span class="cm">    Methods that could cause a bounds change notification are:</span>
<span class="cm">&lt;pre&gt;</span>
<span class="cm">setBounds:</span>
<span class="cm">setBoundsSize:</span>
<span class="cm">setBoundsOrigin:</span>
<span class="cm">&lt;/pre&gt;</span>
<span class="cm">    @param shouldPostBoundsChangedNotifications \c YES makes the receiver post</span>
<span class="cm">    notifications on bounds changes</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setPostsBoundsChangedNotifications:</span><span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">shouldPostBoundsChangedNotifications</span>
<span class="p">{</span>
    <span class="nx">shouldPostBoundsChangedNotifications</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">shouldPostBoundsChangedNotifications</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsBoundsChangedNotifications</span> <span class="o">===</span> <span class="nx">shouldPostBoundsChangedNotifications</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="nx">_postsBoundsChangedNotifications</span> <span class="o">=</span> <span class="nx">shouldPostBoundsChangedNotifications</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_postsBoundsChangedNotifications</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">CachedNotificationCenter</span> <span class="nl">postNotificationName:</span><span class="nx">CPViewBoundsDidChangeNotification</span> <span class="nl">object:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver posts a</span>
<span class="cm">    CPViewBoundsDidChangeNotification when its</span>
<span class="cm">    bounds is changed.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">postsBoundsChangedNotifications</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_postsBoundsChangedNotifications</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Initiates a drag operation from the receiver to another view that accepts dragged data.</span>
<span class="cm">    @param anImage the image to be dragged</span>
<span class="cm">    @param aLocation the lower-left corner coordinate of \c anImage</span>
<span class="cm">    @param mouseOffset the distance from the \c -mouseDown: location and the current location</span>
<span class="cm">    @param anEvent the \c -mouseDown: that triggered the drag</span>
<span class="cm">    @param aPastebaord the pasteboard that holds the drag data</span>
<span class="cm">    @param aSourceObject the drag operation controller</span>
<span class="cm">    @param slideBack Whether the image should &#39;slide back&#39; if the drag is rejected</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">dragImage:</span><span class="p">(</span><span class="nx">CPImage</span><span class="p">)</span><span class="nx">anImage</span> <span class="nl">at:</span><span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">aLocation</span> <span class="nl">offset:</span><span class="p">(</span><span class="nx">CGSize</span><span class="p">)</span><span class="nx">mouseOffset</span> <span class="nl">event:</span><span class="p">(</span><span class="nx">CPEvent</span><span class="p">)</span><span class="nx">anEvent</span> <span class="nl">pasteboard:</span><span class="p">(</span><span class="nx">CPPasteboard</span><span class="p">)</span><span class="nx">aPasteboard</span> <span class="nl">source:</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="nx">aSourceObject</span> <span class="nl">slideBack:</span><span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">slideBack</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">_window</span> <span class="nl">dragImage:</span><span class="nx">anImage</span> <span class="nl">at:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">convertPoint:</span><span class="nx">aLocation</span> <span class="nl">toView:</span><span class="nx">nil</span><span class="k">]</span> <span class="nl">offset:</span><span class="nx">mouseOffset</span> <span class="nl">event:</span><span class="nx">anEvent</span> <span class="nl">pasteboard:</span><span class="nx">aPasteboard</span> <span class="nl">source:</span><span class="nx">aSourceObject</span> <span class="nl">slideBack:</span><span class="nx">slideBack</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Initiates a drag operation from the receiver to another view that accepts dragged data.</span>
<span class="cm">    @param aView the view to be dragged</span>
<span class="cm">    @param aLocation the top-left corner coordinate of \c aView</span>
<span class="cm">    @param mouseOffset the distance from the \c -mouseDown: location and the current location</span>
<span class="cm">    @param anEvent the \c -mouseDown: that triggered the drag</span>
<span class="cm">    @param aPastebaord the pasteboard that holds the drag data</span>
<span class="cm">    @param aSourceObject the drag operation controller</span>
<span class="cm">    @param slideBack Whether the view should &#39;slide back&#39; if the drag is rejected</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">dragView:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">aView</span> <span class="nl">at:</span><span class="p">(</span><span class="nx">CPPoint</span><span class="p">)</span><span class="nx">aLocation</span> <span class="nl">offset:</span><span class="p">(</span><span class="nx">CPSize</span><span class="p">)</span><span class="nx">mouseOffset</span> <span class="nl">event:</span><span class="p">(</span><span class="nx">CPEvent</span><span class="p">)</span><span class="nx">anEvent</span> <span class="nl">pasteboard:</span><span class="p">(</span><span class="nx">CPPasteboard</span><span class="p">)</span><span class="nx">aPasteboard</span> <span class="nl">source:</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="nx">aSourceObject</span> <span class="nl">slideBack:</span><span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">slideBack</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">_window</span> <span class="nl">dragView:</span><span class="nx">aView</span> <span class="nl">at:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">convertPoint:</span><span class="nx">aLocation</span> <span class="nl">toView:</span><span class="nx">nil</span><span class="k">]</span> <span class="nl">offset:</span><span class="nx">mouseOffset</span> <span class="nl">event:</span><span class="nx">anEvent</span> <span class="nl">pasteboard:</span><span class="nx">aPasteboard</span> <span class="nl">source:</span><span class="nx">aSourceObject</span> <span class="nl">slideBack:</span><span class="nx">slideBack</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s list of acceptable data types for a dragging operation.</span>
<span class="cm">    @param pasteboardTypes an array of CPPasteboards</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">registerForDraggedTypes:</span><span class="p">(</span><span class="nx">CPArray</span><span class="p">)</span><span class="nx">pasteboardTypes</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pasteboardTypes</span> <span class="o">||</span> <span class="o">!</span><span class="k">[</span><span class="nx">pasteboardTypes</span> <span class="nl">count</span><span class="k">]</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">theWindow</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">window</span><span class="k">]</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">theWindow</span> <span class="nl">_noteUnregisteredDraggedTypes:</span><span class="nx">_registeredDraggedTypes</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">_registeredDraggedTypes</span> <span class="nl">addObjectsFromArray:</span><span class="nx">pasteboardTypes</span><span class="k">]</span>
    <span class="k">[</span><span class="nx">theWindow</span> <span class="nl">_noteRegisteredDraggedTypes:</span><span class="nx">_registeredDraggedTypes</span><span class="k">]</span><span class="p">;</span>

    <span class="nx">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="nx">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns an array of all types the receiver accepts for dragging operations.</span>
<span class="cm">    @return an array of CPPasteBoards</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CPArray</span><span class="p">)</span><span class="nx">registeredDraggedTypes</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_registeredDraggedTypesArray</span><span class="p">)</span>
        <span class="nx">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="k">[</span><span class="nx">_registeredDraggedTypes</span> <span class="nl">allObjects</span><span class="k">]</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">_registeredDraggedTypesArray</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Resets the array of acceptable data types for a dragging operation.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">unregisterDraggedTypes</span>
<span class="p">{</span>
    <span class="k">[[</span><span class="nx">self</span> <span class="nl">window</span><span class="k">]</span> <span class="nl">_noteUnregisteredDraggedTypes:</span><span class="nx">_registeredDraggedTypes</span><span class="k">]</span><span class="p">;</span>

    <span class="nx">_registeredDraggedTypes</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPSet</span> <span class="nl">set</span><span class="k">]</span><span class="p">;</span>
    <span class="nx">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Draws the receiver into \c aRect. This method should be overridden by subclasses.</span>
<span class="cm">    @param aRect the area that should be drawn into</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">drawRect:</span><span class="p">(</span><span class="nx">CPRect</span><span class="p">)</span><span class="nx">aRect</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="c1">// Displaying</span>

<span class="cm">/*!</span>
<span class="cm">    Marks the entire view as dirty, and needing a redraw.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setNeedsDisplay:</span><span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">aFlag</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">aFlag</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsDisplayInRect:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">bounds</span><span class="k">]]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Marks the area denoted by \c aRect as dirty, and initiates a redraw on it.</span>
<span class="cm">    @param aRect the area that needs to be redrawn</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setNeedsDisplayInRect:</span><span class="p">(</span><span class="nx">CPRect</span><span class="p">)</span><span class="nx">aRect</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">_viewClassFlags</span> <span class="o">&amp;</span> <span class="nx">CPViewHasCustomDrawRect</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="nx">aRect</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_dirtyRect</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="nx">_dirtyRect</span><span class="p">))</span>
        <span class="nx">_dirtyRect</span> <span class="o">=</span> <span class="nf">CGRectUnion</span><span class="p">(</span><span class="nx">aRect</span><span class="p">,</span> <span class="nx">_dirtyRect</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="nx">_dirtyRect</span> <span class="o">=</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="nx">aRect</span><span class="p">);</span>

    <span class="nf">_CPDisplayServerAddDisplayObject</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">needsDisplay</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_dirtyRect</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="nx">_dirtyRect</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Displays the receiver and any of its subviews that need to be displayed.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">displayIfNeeded</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">self</span> <span class="nl">needsDisplay</span><span class="k">]</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">self</span> <span class="nl">displayRect:</span><span class="nx">_dirtyRect</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Draws the entire area of the receiver as defined by its \c -bounds.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">display</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">displayRect:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">visibleRect</span><span class="k">]]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">displayIfNeededInRect:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">aRect</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">self</span> <span class="nl">needsDisplay</span><span class="k">]</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">self</span> <span class="nl">displayRect:</span><span class="nx">aRect</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Draws the receiver into the area defined by \c aRect.</span>
<span class="cm">    @param aRect the area to be drawn</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">displayRect:</span><span class="p">(</span><span class="nx">CPRect</span><span class="p">)</span><span class="nx">aRect</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">viewWillDraw</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">self</span> <span class="nl">displayRectIgnoringOpacity:</span><span class="nx">aRect</span> <span class="nl">inContext:</span><span class="nx">nil</span><span class="k">]</span><span class="p">;</span>
    
    <span class="nx">_dirtyRect</span> <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">displayRectIgnoringOpacity:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">aRect</span> <span class="nl">inContext:</span><span class="p">(</span><span class="nx">CPGraphicsContext</span><span class="p">)</span><span class="nx">aGraphicsContext</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">lockFocus</span><span class="k">]</span><span class="p">;</span>
    
    <span class="nf">CGContextClearRect</span><span class="p">(</span><span class="k">[[</span><span class="nx">CPGraphicsContext</span> <span class="nl">currentContext</span><span class="k">]</span> <span class="nl">graphicsPort</span><span class="k">]</span><span class="p">,</span> <span class="nx">aRect</span><span class="p">);</span>
    
    <span class="k">[</span><span class="nx">self</span> <span class="nl">drawRect:</span><span class="nx">aRect</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">unlockFocus</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">viewWillDraw</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Locks focus on the receiver, so drawing commands apply to it.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">lockFocus</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_graphicsContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">graphicsPort</span> <span class="o">=</span> <span class="nf">CGBitmapGraphicsContextCreate</span><span class="p">();</span>
        
        <span class="nx">_DOMContentsElement</span> <span class="o">=</span> <span class="nx">graphicsPort</span><span class="p">.</span><span class="nx">DOMElement</span><span class="p">;</span>
        
        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>

        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">overflow</span> <span class="o">=</span> <span class="s2">&quot;hidden&quot;</span><span class="p">;</span>
        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;absolute&quot;</span><span class="p">;</span>
        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s2">&quot;visible&quot;</span><span class="p">;</span>
        
        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nf">ROUND</span><span class="p">(</span><span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="nx">_frame</span><span class="p">));</span>
        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nf">ROUND</span><span class="p">(</span><span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="nx">_frame</span><span class="p">));</span>
        
        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="s2">&quot;0px&quot;</span><span class="p">;</span>
        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="s2">&quot;0px&quot;</span><span class="p">;</span>
        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nf">ROUND</span><span class="p">(</span><span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="nx">_frame</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
        <span class="nx">_DOMContentsElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nf">ROUND</span><span class="p">(</span><span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="nx">_frame</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>

        <span class="nf">CPDOMDisplayServerAppendChild</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">_DOMContentsElement</span><span class="p">);</span>
        
        <span class="nx">_graphicsContext</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPGraphicsContext</span> <span class="nl">graphicsContextWithGraphicsPort:</span><span class="nx">graphicsPort</span> <span class="nl">flipped:</span><span class="nx">YES</span><span class="k">]</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">[</span><span class="nx">CPGraphicsContext</span> <span class="nl">setCurrentContext:</span><span class="nx">_graphicsContext</span><span class="k">]</span><span class="p">;</span>
    
    <span class="nf">CGContextSaveGState</span><span class="p">(</span><span class="k">[</span><span class="nx">_graphicsContext</span> <span class="nl">graphicsPort</span><span class="k">]</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Takes focus away from the receiver, and restores it to the previous view.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">unlockFocus</span>
<span class="p">{</span>
    <span class="nf">CGContextRestoreGState</span><span class="p">(</span><span class="k">[</span><span class="nx">_graphicsContext</span> <span class="nl">graphicsPort</span><span class="k">]</span><span class="p">);</span>
    
    <span class="k">[</span><span class="nx">CPGraphicsContext</span> <span class="nl">setCurrentContext:</span><span class="nx">nil</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">setNeedsLayout</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">_viewClassFlags</span> <span class="o">&amp;</span> <span class="nx">CPViewHasCustomLayoutSubviews</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="nx">_needsLayout</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>

    <span class="nf">_CPDisplayServerAddLayoutObject</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">layoutIfNeeded</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_needsLayout</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">_needsLayout</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>
    
        <span class="k">[</span><span class="nx">self</span> <span class="nl">layoutSubviews</span><span class="k">]</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">layoutSubviews</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns whether the receiver is completely opaque. By default, returns \c NO.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">isOpaque</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the rectangle of the receiver not clipped by its superview.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">visibleRect</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_superview</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">_bounds</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="nf">CGRectIntersection</span><span class="p">(</span><span class="k">[</span><span class="nx">self</span> <span class="nl">convertRect:</span><span class="k">[</span><span class="nx">_superview</span> <span class="nl">visibleRect</span><span class="k">]</span> <span class="nl">fromView:</span><span class="nx">_superview</span><span class="k">]</span><span class="p">,</span> <span class="nx">_bounds</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Scrolling</span>
<span class="cm">/* @ignore */</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CPScrollView</span><span class="p">)</span><span class="nx">_enclosingClipView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">superview</span> <span class="o">=</span> <span class="nx">_superview</span><span class="p">,</span>
        <span class="nx">clipViewClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPClipView</span> <span class="nl">class</span><span class="k">]</span><span class="p">;</span>

    <span class="nf">while</span><span class="p">(</span><span class="nx">superview</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">[</span><span class="nx">superview</span> <span class="nl">isKindOfClass:</span><span class="nx">clipViewClass</span><span class="k">]</span><span class="p">)</span> 
        <span class="nx">superview</span> <span class="o">=</span> <span class="nx">superview</span><span class="p">.</span><span class="nx">_superview</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">superview</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Changes the receiver&#39;s frame origin to a &#39;constrained&#39; \c aPoint.</span>
<span class="cm">    @param aPoint the proposed frame origin</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">scrollPoint:</span><span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">aPoint</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">clipView</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">_enclosingClipView</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">clipView</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="k">[</span><span class="nx">clipView</span> <span class="nl">scrollToPoint:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">convertPoint:</span><span class="nx">aPoint</span> <span class="nl">toView:</span><span class="nx">clipView</span><span class="k">]]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Scrolls the nearest ancestor CPClipView a minimum amount so \c aRect can become visible.</span>
<span class="cm">    @param aRect the area to become visible</span>
<span class="cm">    @return &lt;codeYES if any scrolling occurred, \c NO otherwise.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nl">scrollRectToVisible:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">aRect</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">visibleRect</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">visibleRect</span><span class="k">]</span><span class="p">;</span>
    
    <span class="c1">// Make sure we have a rect that exists.</span>
    <span class="nx">aRect</span> <span class="o">=</span> <span class="nf">CGRectIntersection</span><span class="p">(</span><span class="nx">aRect</span><span class="p">,</span> <span class="nx">_bounds</span><span class="p">);</span>
    
    <span class="c1">// If aRect is empty or is already visible then no scrolling required.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="nx">aRect</span><span class="p">)</span> <span class="o">||</span> <span class="nf">CGRectContainsRect</span><span class="p">(</span><span class="nx">visibleRect</span><span class="p">,</span> <span class="nx">aRect</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">enclosingClipView</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">_enclosingClipView</span><span class="k">]</span><span class="p">;</span>
    
    <span class="c1">// If we&#39;re not in a clip view, then there isn&#39;t much we can do.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">enclosingClipView</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="nx">scrollPoint</span> <span class="o">=</span> <span class="nf">_CGPointMakeCopy</span><span class="p">(</span><span class="nx">visibleRect</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
            
    <span class="c1">// One of the following has to be true since our current visible rect didn&#39;t contain aRect.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">aRect</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">visibleRect</span><span class="p">))</span>
        <span class="nx">scrollPoint</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">aRect</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectGetMaxX</span><span class="p">(</span><span class="nx">aRect</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">_CGRectGetMaxX</span><span class="p">(</span><span class="nx">visibleRect</span><span class="p">))</span>
        <span class="nx">scrollPoint</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nf">_CGRectGetMaxX</span><span class="p">(</span><span class="nx">aRect</span><span class="p">)</span> <span class="o">-</span> <span class="nf">_CGRectGetMaxX</span><span class="p">(</span><span class="nx">visibleRect</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="nx">aRect</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="nx">visibleRect</span><span class="p">))</span>
        <span class="nx">scrollPoint</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nf">CGRectGetMinY</span><span class="p">(</span><span class="nx">aRect</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectGetMaxY</span><span class="p">(</span><span class="nx">aRect</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">_CGRectGetMaxY</span><span class="p">(</span><span class="nx">visibleRect</span><span class="p">))</span>
        <span class="nx">scrollPoint</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nf">_CGRectGetMaxY</span><span class="p">(</span><span class="nx">aRect</span><span class="p">)</span> <span class="o">-</span> <span class="nf">_CGRectGetMaxY</span><span class="p">(</span><span class="nx">visibleRect</span><span class="p">);</span>
    
    <span class="k">[</span><span class="nx">enclosingClipView</span> <span class="nl">scrollToPoint:</span><span class="nf">CGPointMake</span><span class="p">(</span><span class="nx">scrollPoint</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">scrollPoint</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">    FIXME Not yet implemented</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nl">autoscroll:</span><span class="p">(</span><span class="nx">CPEvent</span><span class="p">)</span><span class="nx">anEvent</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">[[</span><span class="nx">self</span> <span class="nl">superview</span><span class="k">]</span> <span class="nl">autoscroll:</span><span class="nx">anEvent</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Subclasses can override this to modify the visible rectangle after a</span>
<span class="cm">    scrolling operation. The default implementation simply returns the provided rectangle.</span>
<span class="cm">    @param proposedVisibleRect the rectangle to alter</span>
<span class="cm">    @return the same adjusted rectangle</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nl">adjustScroll:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">proposedVisibleRect</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">proposedVisibleRect</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Should be overridden by subclasses.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">scrollRect:</span><span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nx">aRect</span> <span class="nl">by:</span><span class="p">(</span><span class="kr">float</span><span class="p">)</span><span class="nx">anAmount</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the CPScrollView containing the receiver.</span>
<span class="cm">    @return the CPScrollView containing the receiver.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CPScrollView</span><span class="p">)</span><span class="nx">enclosingScrollView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">superview</span> <span class="o">=</span> <span class="nx">_superview</span><span class="p">,</span>
        <span class="nx">scrollViewClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPScrollView</span> <span class="nl">class</span><span class="k">]</span><span class="p">;</span>

    <span class="nf">while</span><span class="p">(</span><span class="nx">superview</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">[</span><span class="nx">superview</span> <span class="nl">isKindOfClass:</span><span class="nx">scrollViewClass</span><span class="k">]</span><span class="p">)</span> 
        <span class="nx">superview</span> <span class="o">=</span> <span class="nx">superview</span><span class="p">.</span><span class="nx">_superview</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">superview</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Scrolls the clip view to a specified point</span>
<span class="cm">    @param the clip view to scoll</span>
<span class="cm">    @param the point to scroll to</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">scrollClipView:</span><span class="p">(</span><span class="nx">CPClipView</span><span class="p">)</span><span class="nx">aClipView</span> <span class="nl">toPoint:</span><span class="p">(</span><span class="nx">CGPoint</span><span class="p">)</span><span class="nx">aPoint</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">aClipView</span> <span class="nl">scrollToPoint:</span><span class="nx">aPoint</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Notifies the receiver (superview of a CPClipView)</span>
<span class="cm">    that the clip view bounds or the document view bounds have changed.</span>
<span class="cm">    @param aClipView the clip view of the superview being notified</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">reflectScrolledClipView:</span><span class="p">(</span><span class="nx">CPClipView</span><span class="p">)</span><span class="nx">aClipView</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">CPView</span> <span class="p">(</span><span class="nc">KeyView</span><span class="p">)</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nl">performKeyEquivalent:</span><span class="p">(</span><span class="nx">CPEvent</span><span class="p">)</span><span class="nx">anEvent</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">subviews</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">subviews</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">count</span> <span class="o">=</span> <span class="k">[</span><span class="nx">subviews</span> <span class="nl">count</span><span class="k">]</span><span class="p">;</span>

    <span class="c1">// Is reverse iteration correct here? It matches the other (correct) code like hit testing.</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">subviews</span><span class="p">[</span><span class="nx">count</span><span class="p">]</span> <span class="nl">performKeyEquivalent:</span><span class="nx">anEvent</span><span class="k">]</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>

    <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">canBecomeKeyView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">acceptsFirstResponder</span><span class="k">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">[</span><span class="nx">self</span> <span class="nl">isHiddenOrHasHiddenAncestor</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">nextKeyView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_nextKeyView</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">nextValidKeyView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">nextKeyView</span><span class="k">]</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">[</span><span class="nx">result</span> <span class="nl">canBecomeKeyView</span><span class="k">]</span><span class="p">)</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="k">[</span><span class="nx">result</span> <span class="nl">nextKeyView</span><span class="k">]</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">previousKeyView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_previousKeyView</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">previousValidKeyView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">previousKeyView</span><span class="k">]</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">[</span><span class="nx">result</span> <span class="nl">canBecomeKeyView</span><span class="k">]</span><span class="p">)</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="k">[</span><span class="nx">result</span> <span class="nl">previousKeyView</span><span class="k">]</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">_setPreviousKeyView:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">previous</span>
<span class="p">{</span>
    <span class="nx">_previousKeyView</span> <span class="o">=</span> <span class="nx">previous</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setNextKeyView:</span><span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nx">next</span>
<span class="p">{</span>
    <span class="nx">_nextKeyView</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">_nextKeyView</span> <span class="nl">_setPreviousKeyView:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">CPView</span> <span class="p">(</span><span class="nc">CoreAnimationAdditions</span><span class="p">)</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the core animation layer to be used by this receiver.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setLayer:</span><span class="p">(</span><span class="nx">CALayer</span><span class="p">)</span><span class="nx">aLayer</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_layer</span> <span class="o">==</span> <span class="nx">aLayer</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">_layer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">_layer</span><span class="p">.</span><span class="nx">_owningView</span> <span class="o">=</span> <span class="nx">nil</span><span class="p">;</span>
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
        <span class="nx">_DOMElement</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">_layer</span><span class="p">.</span><span class="nx">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    
    <span class="nx">_layer</span> <span class="o">=</span> <span class="nx">aLayer</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">_layer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">bounds</span> <span class="o">=</span> <span class="nf">CGRectMakeCopy</span><span class="p">(</span><span class="k">[</span><span class="nx">self</span> <span class="nl">bounds</span><span class="k">]</span><span class="p">);</span>
        
        <span class="k">[</span><span class="nx">_layer</span> <span class="nl">_setOwningView:</span><span class="nx">self</span><span class="k">]</span><span class="p">;</span>
        
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
        <span class="nx">_layer</span><span class="p">.</span><span class="nx">_DOMElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zIndex</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
        
        <span class="nx">_DOMElement</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">_layer</span><span class="p">.</span><span class="nx">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the core animation layer used by the receiver.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">CALayer</span><span class="p">)</span><span class="nx">layer</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_layer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets whether the receiver wants a core animation layer.</span>
<span class="cm">    @param \c YES means the receiver wants a layer.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setWantsLayer:</span><span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">aFlag</span>
<span class="p">{</span>
    <span class="nx">_wantsLayer</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">aFlag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver uses a CALayer</span>
<span class="cm">    @returns \c YES if the receiver uses a CALayer</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nx">wantsLayer</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_wantsLayer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">CPView</span> <span class="p">(</span><span class="nc">Theming</span><span class="p">)</span>
<span class="cp">#pragma </span><span class="nx">mark</span> <span class="nx">Theme</span> <span class="nx">States</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">unsigned</span><span class="p">)</span><span class="nx">themeState</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_themeState</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nl">hasThemeState:</span><span class="p">(</span><span class="nx">CPThemeState</span><span class="p">)</span><span class="nx">aState</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="nx">_themeState</span> <span class="o">&amp;</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">aState</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nf">CPThemeState</span><span class="p">(</span><span class="nx">aState</span><span class="p">)</span> <span class="o">:</span> <span class="nx">aState</span><span class="p">));</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nl">setThemeState:</span><span class="p">(</span><span class="nx">CPThemeState</span><span class="p">)</span><span class="nx">aState</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">newState</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">aState</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nf">CPThemeState</span><span class="p">(</span><span class="nx">aState</span><span class="p">)</span> <span class="o">:</span> <span class="nx">aState</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_themeState</span> <span class="o">&amp;</span> <span class="nx">newState</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="nx">_themeState</span> <span class="o">|=</span> <span class="nx">newState</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsLayout</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsDisplay:</span><span class="nx">YES</span><span class="k">]</span><span class="p">;</span>

    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">BOOL</span><span class="p">)</span><span class="nl">unsetThemeState:</span><span class="p">(</span><span class="nx">CPThemeState</span><span class="p">)</span><span class="nx">aState</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">newState</span> <span class="o">=</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">aState</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nf">CPThemeState</span><span class="p">(</span><span class="nx">aState</span><span class="p">)</span> <span class="o">:</span> <span class="nx">aState</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">_themeState</span> <span class="o">&amp;</span> <span class="nx">newState</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="nx">_themeState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">newState</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsLayout</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsDisplay:</span><span class="nx">YES</span><span class="k">]</span><span class="p">;</span>

    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#pragma </span><span class="nx">mark</span> <span class="nx">Theme</span> <span class="nx">Attributes</span>

<span class="o">+</span> <span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">themeClass</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="nx">CPDictionary</span><span class="p">)</span><span class="nx">themeAttributes</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="nx">CPArray</span><span class="p">)</span><span class="nx">_themeAttributes</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">CachedThemeAttributes</span><span class="p">)</span>
        <span class="nx">CachedThemeAttributes</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="kd">var</span> <span class="nx">theClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">class</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">CPViewClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPView</span> <span class="nl">class</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">attributes</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="nx">theClass</span> <span class="o">&amp;&amp;</span> <span class="nx">theClass</span> <span class="o">!==</span> <span class="nx">CPViewClass</span><span class="p">;</span> <span class="nx">theClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">theClass</span> <span class="nl">superclass</span><span class="k">]</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cachedAttributes</span> <span class="o">=</span> <span class="nx">CachedThemeAttributes</span><span class="p">[</span><span class="nf">class_getName</span><span class="p">(</span><span class="nx">theClass</span><span class="p">)];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">cachedAttributes</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">attributes</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="nx">cachedAttributes</span><span class="p">)</span> <span class="o">:</span> <span class="nx">attributes</span><span class="p">;</span>
            <span class="nx">CachedThemeAttributes</span><span class="p">[</span><span class="k">[</span><span class="nx">self</span> <span class="nl">className</span><span class="k">]</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">;</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">attributeDictionary</span> <span class="o">=</span> <span class="k">[</span><span class="nx">theClass</span> <span class="nl">themeAttributes</span><span class="k">]</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attributeDictionary</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">attributeKeys</span> <span class="o">=</span> <span class="k">[</span><span class="nx">attributeDictionary</span> <span class="nl">allKeys</span><span class="k">]</span><span class="p">,</span>
            <span class="nx">attributeCount</span> <span class="o">=</span> <span class="nx">attributeKeys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">attributeCount</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">attributeName</span> <span class="o">=</span> <span class="nx">attributeKeys</span><span class="p">[</span><span class="nx">attributeCount</span><span class="p">];</span>

            <span class="nx">attributes</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="k">[</span><span class="nx">attributeDictionary</span> <span class="nl">objectForKey:</span><span class="nx">attributeName</span><span class="k">]</span><span class="p">);</span>
            <span class="nx">attributes</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">attributeName</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">attributes</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">_loadThemeAttributes</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">theClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">class</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">attributes</span> <span class="o">=</span> <span class="k">[</span><span class="nx">theClass</span> <span class="nl">_themeAttributes</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">count</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">count</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">theme</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">theme</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">themeClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">theClass</span> <span class="nl">themeClass</span><span class="k">]</span><span class="p">;</span>

    <span class="nx">_themeAttributes</span> <span class="o">=</span> <span class="p">{};</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">attributeName</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">[</span><span class="nx">count</span><span class="o">--</span><span class="p">],</span>
            <span class="nx">attribute</span> <span class="o">=</span> <span class="k">[[</span><span class="nx">_CPThemeAttribute</span> <span class="nl">alloc</span><span class="k">]</span> <span class="nl">initWithName:</span><span class="nx">attributeName</span> <span class="nl">defaultValue:</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">count</span><span class="p">]</span><span class="k">]</span><span class="p">;</span>

        <span class="k">[</span><span class="nx">attribute</span> <span class="nl">setParentAttribute:</span><span class="k">[</span><span class="nx">theme</span> <span class="nl">_attributeWithName:</span><span class="nx">attributeName</span> <span class="nl">forClass:</span><span class="nx">themeClass</span><span class="k">]]</span><span class="p">;</span>
        
        <span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">attributeName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setTheme:</span><span class="p">(</span><span class="nx">CPTheme</span><span class="p">)</span><span class="nx">aTheme</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_theme</span> <span class="o">===</span> <span class="nx">aTheme</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="nx">_theme</span> <span class="o">=</span> <span class="nx">aTheme</span><span class="p">;</span>
        
    <span class="k">[</span><span class="nx">self</span> <span class="nl">viewDidChangeTheme</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CPTheme</span><span class="p">)</span><span class="nx">theme</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">_theme</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nx">viewDidChangeTheme</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_themeAttributes</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">theme</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">theme</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">themeClass</span> <span class="o">=</span> <span class="k">[[</span><span class="nx">self</span> <span class="nl">class</span><span class="k">]</span> <span class="nl">themeClass</span><span class="k">]</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">attributeName</span> <span class="k">in</span> <span class="nx">_themeAttributes</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_themeAttributes</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="nx">attributeName</span><span class="p">))</span>
            <span class="k">[</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">attributeName</span><span class="p">]</span> <span class="nl">setParentAttribute:</span><span class="k">[</span><span class="nx">theme</span> <span class="nl">_attributeWithName:</span><span class="nx">attributeName</span> <span class="nl">forClass:</span><span class="nx">themeClass</span><span class="k">]]</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsLayout</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsDisplay:</span><span class="nx">YES</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CPDictionary</span><span class="p">)</span><span class="nx">_themeAttributeDictionary</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dictionary</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPDictionary</span> <span class="nl">dictionary</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_themeAttributes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">theme</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">theme</span><span class="k">]</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">attributeName</span> <span class="k">in</span> <span class="nx">_themeAttributes</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_themeAttributes</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="nx">attributeName</span><span class="p">))</span>
                <span class="k">[</span><span class="nx">dictionary</span> <span class="nl">setObject:</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">attributeName</span><span class="p">]</span> <span class="nl">forKey:</span><span class="nx">attributeName</span><span class="k">]</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">dictionary</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setValue:</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="nx">aValue</span> <span class="nl">forThemeAttribute:</span><span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">aName</span> <span class="nl">inState:</span><span class="p">(</span><span class="nx">CPThemeState</span><span class="p">)</span><span class="nx">aState</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">])</span>
        <span class="k">[</span><span class="nx">CPException</span> <span class="nl">raise:</span><span class="nx">CPInvalidArgumentException</span> <span class="nl">reason:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">className</span><span class="k">]</span> <span class="o">+</span> <span class="s2">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="nx">aName</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="k">]</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">currentValue</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">currentValueForThemeAttribute:</span><span class="nx">aName</span><span class="k">]</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">]</span> <span class="nl">setValue:</span><span class="nx">aValue</span> <span class="nl">forState:</span><span class="nx">aState</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">self</span> <span class="nl">currentValueForThemeAttribute:</span><span class="nx">aName</span><span class="k">]</span> <span class="o">===</span> <span class="nx">currentValue</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsDisplay:</span><span class="nx">YES</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsLayout</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">setValue:</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="nx">aValue</span> <span class="nl">forThemeAttribute:</span><span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">aName</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">])</span>
        <span class="k">[</span><span class="nx">CPException</span> <span class="nl">raise:</span><span class="nx">CPInvalidArgumentException</span> <span class="nl">reason:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">className</span><span class="k">]</span> <span class="o">+</span> <span class="s2">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="nx">aName</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="k">]</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">currentValue</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">currentValueForThemeAttribute:</span><span class="nx">aName</span><span class="k">]</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">]</span> <span class="nl">setValue:</span><span class="nx">aValue</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">self</span> <span class="nl">currentValueForThemeAttribute:</span><span class="nx">aName</span><span class="k">]</span> <span class="o">===</span> <span class="nx">currentValue</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsDisplay:</span><span class="nx">YES</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsLayout</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="nl">valueForThemeAttribute:</span><span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">aName</span> <span class="nl">inState:</span><span class="p">(</span><span class="nx">CPThemeState</span><span class="p">)</span><span class="nx">aState</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">])</span>
        <span class="k">[</span><span class="nx">CPException</span> <span class="nl">raise:</span><span class="nx">CPInvalidArgumentException</span> <span class="nl">reason:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">className</span><span class="k">]</span> <span class="o">+</span> <span class="s2">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="nx">aName</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="k">]</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">[</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">]</span> <span class="nl">valueForState:</span><span class="nx">aState</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="nl">valueForThemeAttribute:</span><span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">aName</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">])</span>
        <span class="k">[</span><span class="nx">CPException</span> <span class="nl">raise:</span><span class="nx">CPInvalidArgumentException</span> <span class="nl">reason:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">className</span><span class="k">]</span> <span class="o">+</span> <span class="s2">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="nx">aName</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="k">]</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">[</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">]</span> <span class="nl">value</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">currentValueForThemeAttribute:</span><span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">aName</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">])</span>
        <span class="k">[</span><span class="nx">CPException</span> <span class="nl">raise:</span><span class="nx">CPInvalidArgumentException</span> <span class="nl">reason:</span><span class="k">[</span><span class="nx">self</span> <span class="nl">className</span><span class="k">]</span> <span class="o">+</span> <span class="s2">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="nx">aName</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="k">]</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">[</span><span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">aName</span><span class="p">]</span> <span class="nl">valueForState:</span><span class="nx">_themeState</span><span class="k">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nl">createEphemeralSubviewNamed:</span><span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">aViewName</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CGRect</span><span class="p">)</span><span class="nl">rectForEphemeralSubviewNamed:</span><span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">aViewName</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGRectMakeZero</span><span class="p">();</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="nx">CPView</span><span class="p">)</span><span class="nl">layoutEphemeralSubviewNamed:</span><span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">aViewName</span> 
                           <span class="nl">positioned:</span><span class="p">(</span><span class="nx">CPWindowOrderingMode</span><span class="p">)</span><span class="nx">anOrderingMode</span>
      <span class="nl">relativeToEphemeralSubviewNamed:</span><span class="p">(</span><span class="nx">CPString</span><span class="p">)</span><span class="nx">relativeToViewName</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">_ephemeralSubviewsForNames</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">_ephemeralSubviews</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPSet</span> <span class="nl">set</span><span class="k">]</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">rectForEphemeralSubviewNamed:</span><span class="nx">aViewName</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">frame</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="nx">frame</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">]</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">createEphemeralSubviewNamed:</span><span class="nx">aViewName</span><span class="k">]</span><span class="p">;</span>

            <span class="k">[</span><span class="nx">_ephemeralSubviews</span> <span class="nl">addObject:</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">]</span><span class="k">]</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">])</span>
                <span class="k">[</span><span class="nx">self</span> <span class="nl">addSubview:</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">]</span> <span class="nl">positioned:</span><span class="nx">anOrderingMode</span> <span class="nl">relativeTo:</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">relativeToViewName</span><span class="p">]</span><span class="k">]</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">])</span>
            <span class="k">[</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">]</span> <span class="nl">setFrame:</span><span class="nx">frame</span><span class="k">]</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="k">[</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">]</span> <span class="nl">removeFromSuperview</span><span class="k">]</span><span class="p">;</span>

        <span class="k">[</span><span class="nx">_ephemeralSubviews</span> <span class="nl">removeObject:</span><span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">]</span><span class="k">]</span><span class="p">;</span>
        <span class="k">delete</span> <span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="nx">aViewName</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="kd">var</span> <span class="nx">CPViewAutoresizingMaskKey</span>       <span class="o">=</span> <span class="s2">@&quot;CPViewAutoresizingMask&quot;</span><span class="p">,</span>
    <span class="nx">CPViewAutoresizesSubviewsKey</span>    <span class="o">=</span> <span class="s2">@&quot;CPViewAutoresizesSubviews&quot;</span><span class="p">,</span>
    <span class="nx">CPViewBackgroundColorKey</span>        <span class="o">=</span> <span class="s2">@&quot;CPViewBackgroundColor&quot;</span><span class="p">,</span>
    <span class="nx">CPViewBoundsKey</span>                 <span class="o">=</span> <span class="s2">@&quot;CPViewBoundsKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewFrameKey</span>                  <span class="o">=</span> <span class="s2">@&quot;CPViewFrameKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewHitTestsKey</span>               <span class="o">=</span> <span class="s2">@&quot;CPViewHitTestsKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewIsHiddenKey</span>               <span class="o">=</span> <span class="s2">@&quot;CPViewIsHiddenKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewOpacityKey</span>                <span class="o">=</span> <span class="s2">@&quot;CPViewOpacityKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewSubviewsKey</span>               <span class="o">=</span> <span class="s2">@&quot;CPViewSubviewsKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewSuperviewKey</span>              <span class="o">=</span> <span class="s2">@&quot;CPViewSuperviewKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewTagKey</span>                    <span class="o">=</span> <span class="s2">@&quot;CPViewTagKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewThemeStateKey</span>             <span class="o">=</span> <span class="s2">@&quot;CPViewThemeStateKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewWindowKey</span>                 <span class="o">=</span> <span class="s2">@&quot;CPViewWindowKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewNextKeyViewKey</span>            <span class="o">=</span> <span class="s2">@&quot;CPViewNextKeyViewKey&quot;</span><span class="p">,</span>
    <span class="nx">CPViewPreviousKeyViewKey</span>        <span class="o">=</span> <span class="s2">@&quot;CPViewPreviousKeyViewKey&quot;</span><span class="p">;</span>

<span class="k">@implementation</span> <span class="nc">CPView</span> <span class="p">(</span><span class="nc">CPCoding</span><span class="p">)</span>

<span class="cm">/*!</span>
<span class="cm">    Initializes the view from an archive.</span>
<span class="cm">    @param aCoder the coder from which to initialize</span>
<span class="cm">    @return the initialized view</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="nl">initWithCoder:</span><span class="p">(</span><span class="nx">CPCoder</span><span class="p">)</span><span class="nx">aCoder</span>
<span class="p">{</span>
    <span class="c1">// We create the DOMElement &quot;early&quot; because there is a chance that we </span>
    <span class="c1">// will decode our superview before we are done decoding, at which point </span>
    <span class="c1">// we have to have an element to place in the tree.  Perhaps there is </span>
    <span class="c1">// a more &quot;elegant&quot; way to do this...?</span>
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
    <span class="nx">_DOMElement</span> <span class="o">=</span> <span class="nx">DOMElementPrototype</span><span class="p">.</span><span class="nf">cloneNode</span><span class="p">(</span><span class="nx">false</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="c1">// Also decode these &quot;early&quot;.</span>
    <span class="nx">_frame</span> <span class="o">=</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeRectForKey:</span><span class="nx">CPViewFrameKey</span><span class="k">]</span><span class="p">;</span>
    <span class="nx">_bounds</span> <span class="o">=</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeRectForKey:</span><span class="nx">CPViewBoundsKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">self</span> <span class="o">=</span> <span class="k">[</span><span class="nx">super</span> <span class="nl">initWithCoder:</span><span class="nx">aCoder</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// We have to manually check because it may be 0, so we can&#39;t use ||</span>
        <span class="nx">_tag</span> <span class="o">=</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">containsValueForKey:</span><span class="nx">CPViewTagKey</span><span class="k">]</span> <span class="o">?</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeIntForKey:</span><span class="nx">CPViewTagKey</span><span class="k">]</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        
        <span class="nx">_window</span> <span class="o">=</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeObjectForKey:</span><span class="nx">CPViewWindowKey</span><span class="k">]</span><span class="p">;</span>
        <span class="nx">_subviews</span> <span class="o">=</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeObjectForKey:</span><span class="nx">CPViewSubviewsKey</span><span class="k">]</span> <span class="o">||</span> <span class="p">[];</span>
        <span class="nx">_superview</span> <span class="o">=</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeObjectForKey:</span><span class="nx">CPViewSuperviewKey</span><span class="k">]</span><span class="p">;</span>
        
        <span class="c1">// FIXME: Should we encode/decode this?</span>
        <span class="nx">_registeredDraggedTypes</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPSet</span> <span class="nl">set</span><span class="k">]</span><span class="p">;</span>
        <span class="nx">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nx">_autoresizingMask</span> <span class="o">=</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeIntForKey:</span><span class="nx">CPViewAutoresizingMaskKey</span><span class="k">]</span> <span class="o">||</span> <span class="nx">CPViewNotSizable</span><span class="p">;</span>
        <span class="nx">_autoresizesSubviews</span> <span class="o">=</span> <span class="o">!</span><span class="k">[</span><span class="nx">aCoder</span> <span class="nl">containsValueForKey:</span><span class="nx">CPViewAutoresizesSubviewsKey</span><span class="k">]</span> <span class="o">||</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeBoolForKey:</span><span class="nx">CPViewAutoresizesSubviewsKey</span><span class="k">]</span><span class="p">;</span>

        <span class="nx">_hitTests</span> <span class="o">=</span> <span class="o">!</span><span class="k">[</span><span class="nx">aCoder</span> <span class="nl">containsValueForKey:</span><span class="nx">CPViewHitTestsKey</span><span class="k">]</span> <span class="o">||</span> <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeObjectForKey:</span><span class="nx">CPViewHitTestsKey</span><span class="k">]</span><span class="p">;</span>
    
        <span class="c1">// DOM SETUP</span>
<span class="cp">#if </span><span class="nf">PLATFORM</span><span class="p">(</span><span class="nx">DOM</span><span class="p">)</span>
        <span class="nx">_DOMImageParts</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">_DOMImageSizes</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">_frame</span><span class="p">),</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="nx">_frame</span><span class="p">));</span>
        <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="nx">_frame</span><span class="p">),</span> <span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="nx">_frame</span><span class="p">));</span>
        
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">count</span> <span class="o">=</span> <span class="nx">_subviews</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    
        <span class="k">for</span> <span class="p">(;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="o">++</span><span class="nx">index</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CPDOMDisplayServerAppendChild</span><span class="p">(</span><span class="nx">_DOMElement</span><span class="p">,</span> <span class="nx">_subviews</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">_DOMElement</span><span class="p">);</span>
            <span class="c1">//_subviews[index]._superview = self;</span>
        <span class="p">}</span>
<span class="cp">#endif</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">aCoder</span> <span class="nl">containsValueForKey:</span><span class="nx">CPViewIsHiddenKey</span><span class="k">]</span><span class="p">)</span>
            <span class="k">[</span><span class="nx">self</span> <span class="nl">setHidden:</span><span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeBoolForKey:</span><span class="nx">CPViewIsHiddenKey</span><span class="k">]]</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="nx">_isHidden</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">aCoder</span> <span class="nl">containsValueForKey:</span><span class="nx">CPViewOpacityKey</span><span class="k">]</span><span class="p">)</span>
            <span class="k">[</span><span class="nx">self</span> <span class="nl">setAlphaValue:</span><span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeIntForKey:</span><span class="nx">CPViewOpacityKey</span><span class="k">]]</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="nx">_opacity</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

        <span class="k">[</span><span class="nx">self</span> <span class="nl">setBackgroundColor:</span><span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeObjectForKey:</span><span class="nx">CPViewBackgroundColorKey</span><span class="k">]]</span><span class="p">;</span>

        <span class="k">[</span><span class="nx">self</span> <span class="nl">setupViewFlags</span><span class="k">]</span><span class="p">;</span>

        <span class="nx">_theme</span> <span class="o">=</span> <span class="k">[</span><span class="nx">CPTheme</span> <span class="nl">defaultTheme</span><span class="k">]</span><span class="p">;</span>
        <span class="nx">_themeState</span> <span class="o">=</span> <span class="nf">CPThemeState</span><span class="p">(</span><span class="k">[</span><span class="nx">aCoder</span> <span class="nl">decodeIntForKey:</span><span class="nx">CPViewThemeStateKey</span><span class="k">]</span><span class="p">);</span>
        <span class="nx">_themeAttributes</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="kd">var</span> <span class="nx">theClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">class</span><span class="k">]</span><span class="p">,</span>
            <span class="nx">themeClass</span> <span class="o">=</span> <span class="k">[</span><span class="nx">theClass</span> <span class="nl">themeClass</span><span class="k">]</span><span class="p">,</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="k">[</span><span class="nx">theClass</span> <span class="nl">_themeAttributes</span><span class="k">]</span><span class="p">,</span>
            <span class="nx">count</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">attributeName</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">[</span><span class="nx">count</span><span class="o">--</span><span class="p">];</span>

            <span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">attributeName</span><span class="p">]</span> <span class="o">=</span> <span class="nf">CPThemeAttributeDecode</span><span class="p">(</span><span class="nx">aCoder</span><span class="p">,</span> <span class="nx">attributeName</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">[</span><span class="nx">count</span><span class="p">],</span> <span class="nx">_theme</span><span class="p">,</span> <span class="nx">themeClass</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsDisplay:</span><span class="nx">YES</span><span class="k">]</span><span class="p">;</span>
        <span class="k">[</span><span class="nx">self</span> <span class="nl">setNeedsLayout</span><span class="k">]</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Archives the view to a coder.</span>
<span class="cm">    @param aCoder the object into which the view&#39;s data will be archived.</span>
<span class="cm">*/</span>
<span class="o">-</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span><span class="nl">encodeWithCoder:</span><span class="p">(</span><span class="nx">CPCoder</span><span class="p">)</span><span class="nx">aCoder</span>
<span class="p">{</span>
    <span class="k">[</span><span class="nx">super</span> <span class="nl">encodeWithCoder:</span><span class="nx">aCoder</span><span class="k">]</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">_tag</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeInt:</span><span class="nx">_tag</span> <span class="nl">forKey:</span><span class="nx">CPViewTagKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeRect:</span><span class="nx">_frame</span> <span class="nl">forKey:</span><span class="nx">CPViewFrameKey</span><span class="k">]</span><span class="p">;</span>
    <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeRect:</span><span class="nx">_bounds</span> <span class="nl">forKey:</span><span class="nx">CPViewBoundsKey</span><span class="k">]</span><span class="p">;</span>

    <span class="c1">// This will come out nil on the other side with decodeObjectForKey:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_window</span> <span class="o">!==</span> <span class="nx">nil</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeConditionalObject:</span><span class="nx">_window</span> <span class="nl">forKey:</span><span class="nx">CPViewWindowKey</span><span class="k">]</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">[</span><span class="nx">_subviews</span> <span class="nl">count</span><span class="k">]</span><span class="p">,</span>
        <span class="nx">encodedSubviews</span> <span class="o">=</span> <span class="nx">_subviews</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">[</span><span class="nx">_ephemeralSubviews</span> <span class="nl">count</span><span class="k">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">encodedSubviews</span> <span class="o">=</span> <span class="k">[</span><span class="nx">encodedSubviews</span> <span class="nl">copy</span><span class="k">]</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">[</span><span class="nx">_ephemeralSubviews</span> <span class="nl">containsObject:</span><span class="nx">encodedSubviews</span><span class="p">[</span><span class="nx">count</span><span class="p">]</span><span class="k">]</span><span class="p">)</span>
                <span class="nx">encodedSubviews</span><span class="p">.</span><span class="nf">splice</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">encodedSubviews</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeObject:</span><span class="nx">encodedSubviews</span> <span class="nl">forKey:</span><span class="nx">CPViewSubviewsKey</span><span class="k">]</span><span class="p">;</span>

    <span class="c1">// This will come out nil on the other side with decodeObjectForKey:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_superview</span> <span class="o">!==</span> <span class="nx">nil</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeConditionalObject:</span><span class="nx">_superview</span> <span class="nl">forKey:</span><span class="nx">CPViewSuperviewKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_autoresizingMask</span> <span class="o">!==</span> <span class="nx">CPViewNotSizable</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeInt:</span><span class="nx">_autoresizingMask</span> <span class="nl">forKey:</span><span class="nx">CPViewAutoresizingMaskKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_autoresizesSubviews</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeBool:</span><span class="nx">_autoresizesSubviews</span> <span class="nl">forKey:</span><span class="nx">CPViewAutoresizesSubviewsKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_backgroundColor</span> <span class="o">!==</span> <span class="nx">nil</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeObject:</span><span class="nx">_backgroundColor</span> <span class="nl">forKey:</span><span class="nx">CPViewBackgroundColorKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_hitTests</span> <span class="o">!==</span> <span class="kc">YES</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeBool:</span><span class="nx">_hitTests</span> <span class="nl">forKey:</span><span class="nx">CPViewHitTestsKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_opacity</span> <span class="o">!==</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeFloat:</span><span class="nx">_opacity</span> <span class="nl">forKey:</span><span class="nx">CPViewOpacityKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_isHidden</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeBool:</span><span class="nx">_isHidden</span> <span class="nl">forKey:</span><span class="nx">CPViewIsHiddenKey</span><span class="k">]</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">nextKeyView</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">nextKeyView</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">nextKeyView</span> <span class="o">!==</span> <span class="nx">nil</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeConditionalObject:</span><span class="nx">nextKeyView</span> <span class="nl">forKey:</span><span class="nx">CPViewNextKeyViewKey</span><span class="k">]</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">previousKeyView</span> <span class="o">=</span> <span class="k">[</span><span class="nx">self</span> <span class="nl">previousKeyView</span><span class="k">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">previousKeyView</span> <span class="o">!==</span> <span class="nx">nil</span><span class="p">)</span>
        <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeConditionalObject:</span><span class="nx">previousKeyView</span> <span class="nl">forKey:</span><span class="nx">CPViewPreviousKeyViewKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">[</span><span class="nx">aCoder</span> <span class="nl">encodeInt:</span><span class="nf">CPThemeStateName</span><span class="p">(</span><span class="nx">_themeState</span><span class="p">)</span> <span class="nl">forKey:</span><span class="nx">CPViewThemeStateKey</span><span class="k">]</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">attributeName</span> <span class="k">in</span> <span class="nx">_themeAttributes</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_themeAttributes</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="nx">attributeName</span><span class="p">))</span>
            <span class="nf">CPThemeAttributeEncode</span><span class="p">(</span><span class="nx">aCoder</span><span class="p">,</span> <span class="nx">_themeAttributes</span><span class="p">[</span><span class="nx">attributeName</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="kd">var</span> <span class="nx">_CPViewFullScreenModeStateMake</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="nx">aView</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">superview</span> <span class="o">=</span> <span class="nx">aView</span><span class="p">.</span><span class="nx">_superview</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="p">{</span> <span class="nl">autoresizingMask:</span><span class="nx">aView</span><span class="p">.</span><span class="nx">_autoresizingMask</span><span class="p">,</span> <span class="nl">frame:</span><span class="nf">CGRectMakeCopy</span><span class="p">(</span><span class="nx">aView</span><span class="p">.</span><span class="nx">_frame</span><span class="p">),</span> <span class="nl">index:</span><span class="p">(</span><span class="nx">superview</span> <span class="o">?</span> <span class="k">[</span><span class="nx">superview</span><span class="p">.</span><span class="nx">_subviews</span> <span class="nl">indexOfObjectIdenticalTo:</span><span class="nx">aView</span><span class="k">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="nl">superview:</span><span class="nx">superview</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_CPViewGetTransform</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="cm">/*CPView*/ </span><span class="nx">fromView</span><span class="p">,</span> <span class="cm">/*CPView */</span> <span class="nx">toView</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">transform</span> <span class="o">=</span> <span class="nf">CGAffineTransformMakeIdentity</span><span class="p">(),</span>
        <span class="nx">sameWindow</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">,</span>
        <span class="nx">fromWindow</span> <span class="o">=</span> <span class="nx">nil</span><span class="p">,</span>
        <span class="nx">toWindow</span> <span class="o">=</span> <span class="nx">nil</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">fromView</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">fromView</span><span class="p">;</span>
        
        <span class="c1">// FIXME: This doesn&#39;t handle the case when the outside views are equal.</span>
        <span class="c1">// If we have a fromView, &quot;climb up&quot; the view tree until </span>
        <span class="c1">// we hit the root node or we hit the toLayer.</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">view</span> <span class="o">&amp;&amp;</span> <span class="nx">view</span> <span class="o">!=</span> <span class="nx">toView</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_frame</span><span class="p">;</span>
            
            <span class="nx">transform</span><span class="p">.</span><span class="nx">tx</span> <span class="o">+=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
            <span class="nx">transform</span><span class="p">.</span><span class="nx">ty</span> <span class="o">+=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">_boundsTransform</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">_CGAffineTransformConcatTo</span><span class="p">(</span><span class="nx">transform</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_boundsTransform</span><span class="p">,</span> <span class="nx">transform</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="nx">view</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_superview</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">// If we hit toView, then we&#39;re done.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">view</span> <span class="o">===</span> <span class="nx">toView</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">transform</span><span class="p">;</span>
        
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fromView</span> <span class="o">&amp;&amp;</span> <span class="nx">toView</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">fromWindow</span> <span class="o">=</span> <span class="k">[</span><span class="nx">fromView</span> <span class="nl">window</span><span class="k">]</span><span class="p">;</span>
            <span class="nx">toWindow</span> <span class="o">=</span> <span class="k">[</span><span class="nx">toView</span> <span class="nl">window</span><span class="k">]</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">fromWindow</span> <span class="o">&amp;&amp;</span> <span class="nx">toWindow</span> <span class="o">&amp;&amp;</span> <span class="nx">fromWindow</span> <span class="o">!==</span> <span class="nx">toWindow</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">sameWindow</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>
                
                <span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="k">[</span><span class="nx">fromWindow</span> <span class="nl">frame</span><span class="k">]</span><span class="p">;</span>
                
                <span class="nx">transform</span><span class="p">.</span><span class="nx">tx</span> <span class="o">+=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
                <span class="nx">transform</span><span class="p">.</span><span class="nx">ty</span> <span class="o">+=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// FIXME: For now we can do things this way, but eventually we need to do them the &quot;hard&quot; way.</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">toView</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="nx">view</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_frame</span><span class="p">;</span>
            
        <span class="nx">transform</span><span class="p">.</span><span class="nx">tx</span> <span class="o">-=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
        <span class="nx">transform</span><span class="p">.</span><span class="nx">ty</span> <span class="o">-=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">_boundsTransform</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">_CGAffineTransformConcatTo</span><span class="p">(</span><span class="nx">transform</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_inverseBoundsTransform</span><span class="p">,</span> <span class="nx">transform</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="nx">view</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_superview</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sameWindow</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="k">[</span><span class="nx">toWindow</span> <span class="nl">frame</span><span class="k">]</span><span class="p">;</span>
            
        <span class="nx">transform</span><span class="p">.</span><span class="nx">tx</span> <span class="o">-=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
        <span class="nx">transform</span><span class="p">.</span><span class="nx">ty</span> <span class="o">-=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cm">/*    var views = [],</span>
<span class="cm">        view = toView;</span>
<span class="cm">    </span>
<span class="cm">    while (view)</span>
<span class="cm">    {</span>
<span class="cm">        views.push(view);</span>
<span class="cm">        view = view._superview;</span>
<span class="cm">    }</span>
<span class="cm">    </span>
<span class="cm">    var index = views.length;</span>
<span class="cm">    </span>
<span class="cm">    while (index--)</span>
<span class="cm">    {</span>
<span class="cm">        var frame = views[index]._frame;</span>
<span class="cm">            </span>
<span class="cm">        transform.tx -= _CGRectGetMinX(frame);</span>
<span class="cm">        transform.ty -= _CGRectGetMinY(frame);</span>
<span class="cm">    }*/</span>
    
    <span class="k">return</span> <span class="nx">transform</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</body>
</html>
